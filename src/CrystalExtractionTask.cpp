#include "CrystalExtractionTask.h"

#include "Directory.h"
#include "InvalidFileException.h"

#include "LengthCasting.h"

#include "AtomicRadiusDictionary.h"
#include "CoordinationConstraintsDictionary.h"
#include "FeasiblePolyhedraConnectionsDictionary.h"

using namespace MathematicalCrystalChemistry::Extraction;


// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Constructors

double CrystalExtractionTask::s_defaultSpaceGroupPrecision{ MathToolkit::UnitConversion::LengthCasting::cast<MathToolkit::UnitConversion::LengthCasting::Unit::Angstrom, MathToolkit::UnitConversion::LengthCasting::Unit::AtomicUnit>(0.5) };


CrystalExtractionTask::CrystalExtractionTask() noexcept
	: _inputCrystalsDirectoryPath{}
	, _outputCrystalsDirectoryPath{}
	, _spaceGroupPrecision{ s_defaultSpaceGroupPrecision }
	, _geometricalConstraintParameters{}
	, _crystalOptimalityAnalysisParameters{}
	, _isotypicCrystalExtractionParameters{}
	, _promisingCrystalExtractionParameters{}
{
}

// Constructors
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Property

void CrystalExtractionTask::setInputDirectoryPath(const std::filesystem::path& directoryPath)
{
	if (System::IO::Directory::exist(directoryPath))
		_inputCrystalsDirectoryPath = directoryPath;
	else
		throw System::ExceptionServices::ArgumentOutOfRangeException{ typeid(*this), "setInputDirectoryPath", "Argument directory path is empty." };
}

void CrystalExtractionTask::setOutputDirectoryPath(const std::filesystem::path& directoryPath)
{
	if (System::IO::Directory::exist(directoryPath))
		_outputCrystalsDirectoryPath = directoryPath;
	else
		throw System::ExceptionServices::ArgumentOutOfRangeException{ typeid(*this), "setOutputDirectoryPath", "Argument directory path is empty." };
}

// Property
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Methods

void CrystalExtractionTask::initialize() noexcept
{
	_inputCrystalsDirectoryPath.clear();
	_outputCrystalsDirectoryPath.clear();

	_spaceGroupPrecision = s_defaultSpaceGroupPrecision;
	_geometricalConstraintParameters.initialize();

	_crystalOptimalityAnalysisParameters.initialize();
	_isotypicCrystalExtractionParameters.initialize();
	_promisingCrystalExtractionParameters.initialize();


	MathematicalCrystalChemistry::CrystalModel::Constraints::AtomicRadiusDictionary::initialize();
	MathematicalCrystalChemistry::CrystalModel::Constraints::CoordinationConstraintsDictionary::initialize();
	MathematicalCrystalChemistry::CrystalModel::Constraints::FeasiblePolyhedraConnectionsDictionary::initialize();
}

void CrystalExtractionTask::initialize(const System::IO::StreamReader& inputStreamReader)
{
	System::IO::StreamReader genericStreamReader = inputStreamReader.getListBlock("&", "CRYSTAL_EXTRACTION_GENERIC");
	{
		if (genericStreamReader.readParameter("Cif.Data.Directory.Path", _inputCrystalsDirectoryPath))
		{
			if (!(System::IO::Directory::exist(_inputCrystalsDirectoryPath)))
				throw System::ExceptionServices::ArgumentOutOfRangeException{ typeid(*this), "initialize", "Argument directory path is empty." };
		}

		if (genericStreamReader.readParameter("Extracted.Crystals.Directory.Path", _outputCrystalsDirectoryPath))
		{
			if (!(System::IO::Directory::exist(_outputCrystalsDirectoryPath)))
				throw System::ExceptionServices::ArgumentOutOfRangeException{ typeid(*this), "initialize", "Argument directory path is empty." };
		}

		{
			double precisionAngstrom = 0.0;

			using namespace MathToolkit::UnitConversion;

			if (genericStreamReader.readParameter("Space.Group.Precision", precisionAngstrom))
				_spaceGroupPrecision = LengthCasting::cast<LengthCasting::Unit::Angstrom, LengthCasting::Unit::AtomicUnit>(precisionAngstrom);
			else
				_spaceGroupPrecision = s_defaultSpaceGroupPrecision;
		}
	}

	_geometricalConstraintParameters.initialize(inputStreamReader.getListBlock("&", "GEOMETRICAL_CONSTRAINTS"));
	_crystalOptimalityAnalysisParameters.initialize(inputStreamReader);
	_isotypicCrystalExtractionParameters.initialize(inputStreamReader);
	_promisingCrystalExtractionParameters.initialize(inputStreamReader);


	MathematicalCrystalChemistry::CrystalModel::Constraints::AtomicRadiusDictionary::initialize(inputStreamReader.getListBlock("&", "ATOMIC_RADIUS"));
	MathematicalCrystalChemistry::CrystalModel::Constraints::CoordinationConstraintsDictionary::initialize(inputStreamReader);
	MathematicalCrystalChemistry::CrystalModel::Constraints::FeasiblePolyhedraConnectionsDictionary::initialize(inputStreamReader);
}

// Methods
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Private methods

void CrystalExtractionTask::validateInitializedValues() const
{
	if (_spaceGroupPrecision < 0.0)
		throw System::IO::InvalidFileException{ typeid(*this), "validateInitializedValues", "\"Space.Group.Precision\" is less than zero." };
}

// Methods
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
