#include "PromisingCrystalExtractor.h"

using namespace MathematicalCrystalChemistry::Analysis;


// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Constructors

PromisingCrystalExtractor::PromisingCrystalExtractor() noexcept
	: _promisingCrystalExtractionParameters{}
{
}

PromisingCrystalExtractor::PromisingCrystalExtractor(const PromisingCrystalExtractionParameters& parameters) noexcept
	: _promisingCrystalExtractionParameters{ parameters }
{
}

// Constructors
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Methods

bool PromisingCrystalExtractor::isPromising(const OptimalCrystalStructure& optimalCrystalStructure) const
{
	if (optimalCrystalStructure.spaceGroupNumber() < _promisingCrystalExtractionParameters.feasibleSpaceGroupRange().first)
		return false;

	else if (_promisingCrystalExtractionParameters.feasibleSpaceGroupRange().second < optimalCrystalStructure.spaceGroupNumber())
		return false;

	else
	{
		std::map<IonicAtomicNumber, size_type> atomicEnvironmentDictionary = countAtomicEnvironments(optimalCrystalStructure);
		{
			size_type numTotalAtomicEnvironments{ 0 };
			size_type numTotalAnionicEnvironments{ 0 };
			size_type numTotalCationicEnvironments{ 0 };
			{
				for (const auto& numAndCount : atomicEnvironmentDictionary)
				{
					numTotalAtomicEnvironments += numAndCount.second;


					if (numAndCount.first.formalCharge().isAnion())
						numTotalAnionicEnvironments += numAndCount.second;

					if (numAndCount.first.formalCharge().isCation())
						numTotalCationicEnvironments += numAndCount.second;
				}
			}


			if (_promisingCrystalExtractionParameters.maximumAtomicEnvironments() < numTotalAtomicEnvironments)
				return false;

			if (_promisingCrystalExtractionParameters.maximumAnionicEnvironments() < numTotalAnionicEnvironments)
				return false;

			if (_promisingCrystalExtractionParameters.maximumCationicEnvironments() < numTotalCationicEnvironments)
				return false;
		}


		for (const auto& numberAndCount : atomicEnvironmentDictionary)
		{
			if (_promisingCrystalExtractionParameters.maximumAtomicEnvironmentsPerElement() < numberAndCount.second)
				return false;

			if (numberAndCount.first.formalCharge().isAnion())
			{
				if (_promisingCrystalExtractionParameters.maximumAtomicEnvironmentsPerAnionicElement() < numberAndCount.second)
					return false;
			}

			if (numberAndCount.first.formalCharge().isCation())
			{
				if (_promisingCrystalExtractionParameters.maximumAtomicEnvironmentsPerCationicElement() < numberAndCount.second)
					return false;
			}
		}
	}


	return true;
}

// Methods
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Private methods

std::map<PromisingCrystalExtractor::IonicAtomicNumber, PromisingCrystalExtractor::size_type> PromisingCrystalExtractor::countAtomicEnvironments(const OptimalCrystalStructure& optimalCrystalStructure) const
{
	std::vector<OptimalAtom> uniqueOptimalAtoms;
	{
		for (const auto& optimalAtom : optimalCrystalStructure.atoms())
		{
			bool isRegisteredOptimalAtom = false;
			{
				for (const auto& uniqueOptimalAtom : uniqueOptimalAtoms)
				{
					if (hasSameAtomicEnvironment(optimalAtom, uniqueOptimalAtom))
					{
						isRegisteredOptimalAtom = true;
						break;
					}
				}
			}

			if (!isRegisteredOptimalAtom)
				uniqueOptimalAtoms.push_back(optimalAtom);
		}
	}

	std::map<IonicAtomicNumber, size_type> atomicEnvironmentDictionary;
	{
		for (const auto& uniqueOptimalAtom : uniqueOptimalAtoms)
		{
			auto iter = atomicEnvironmentDictionary.find(uniqueOptimalAtom.ionicAtomicNumber());


			if (iter == atomicEnvironmentDictionary.end())
				atomicEnvironmentDictionary.emplace(uniqueOptimalAtom.ionicAtomicNumber(), 1);
			else
				iter->second += 1;
		}
	}


	return atomicEnvironmentDictionary;
}

// Private methods
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Private utility

bool PromisingCrystalExtractor::hasSameAtomicEnvironment(const OptimalAtom& firstAtom, const OptimalAtom& secondAtom) const
{
	if (_promisingCrystalExtractionParameters.identifySiteLabel())
	{
		if (firstAtom.siteLabel() != secondAtom.siteLabel())
			return false;
	}

	if (_promisingCrystalExtractionParameters.identifySiteSymmetry())
	{
		if (firstAtom.siteSymmetrySymbol() != secondAtom.siteSymmetrySymbol())
			return false;
	}

	if (_promisingCrystalExtractionParameters.identifyCoordinations())
	{
		if (firstAtom.coordinations() != secondAtom.coordinations())
			return false;
	}

	if (_promisingCrystalExtractionParameters.identifyCoordinationPolyhedraLinkings())
	{
		if (firstAtom.vertexSharings() != secondAtom.vertexSharings())
			return false;
		if (firstAtom.edgeSharings() != secondAtom.edgeSharings())
			return false;
		if (firstAtom.faceSharings() != secondAtom.faceSharings())
			return false;
	}

	return true;
}

// Private utility
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
