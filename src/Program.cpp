#include "Program.h"

#include <regex>
#include <thread>

#include "ThreadingPolicy.h"
#include "MpiPolicy.h"

#include "Directory.h"
#include "File.h"
#include "FileStream.h"
#include "StreamReader.h"

#include "CrystalExtractor.h"
#include "CrystalPredictor.h"

using namespace System::Marici;


// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Constructor

Program::Program(int argc, char* argv[])
	: _commandLineArgument{}
	, _executionMode{ ExecutionMode::crystal_prediction }
	, _inputFilePath{}
{
	for (int index = 0; index < argc; ++index)
		_commandLineArgument.push_back(std::string{ argv[index] });
}

// Constructor
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Methods

int Program::execute()
{
	outputInitialConsoleMessage();
	initializeThreadingPolicy();
	setExecutionMode();

	System::IO::StreamReader inputFileStreamReader;
	{
		readInputFilePath();

		System::IO::FileStream fileStream{ _inputFilePath, System::IO::FileStream::FileMode::openRead };
		inputFileStreamReader.pushBackAllLines(fileStream.readAllLines());
	}



	if (_executionMode == ExecutionMode::crystal_extraction)
	{
		MathematicalCrystalChemistry::Extraction::CrystalExtractionTask crystalExtractionTask;
		crystalExtractionTask.initialize(inputFileStreamReader);

		MathematicalCrystalChemistry::Extraction::CrystalExtractor crystalExtractor{ crystalExtractionTask };
		crystalExtractor.execute();
	}

	if (_executionMode == ExecutionMode::crystal_prediction)
	{
		MathematicalCrystalChemistry::Prediction::CrystalPredictionTask crystalPredictionTask;
		crystalPredictionTask.initialize(inputFileStreamReader);

		MathematicalCrystalChemistry::Prediction::CrystalPredictor crystalPredictor{ crystalPredictionTask };
		{
			if (hasCommandLineFlag("--std=disabled"))
				crystalPredictor.disableStdout();
		}

		crystalPredictor.execute();
	}


	return 0;
}

// Methods
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Private methods

void Program::initializeThreadingPolicy() const
{
	size_type threadNumber = 0;
	{
		std::string threadText = readCommandLineArgument(std::string{ "-t" });

		
		if (threadText.empty())
			threadNumber = std::thread::hardware_concurrency();
		else
			threadNumber = static_cast<size_type>(std::stoi(threadText));
	}


	System::Parallel::ThreadingPolicy::setMaxThreading(threadNumber);
	System::Parallel::ThreadingPolicy::setMklThreading(1);
}

void Program::setExecutionMode()
{
	bool hasCrystalExtractionCommand = hasCommandLineFlag("--crystal=extraction");
	bool hasCrystalPredictionCommand = hasCommandLineFlag("--crystal=prediction");


	if (hasCrystalExtractionCommand && !hasCrystalPredictionCommand)
		_executionMode = ExecutionMode::crystal_extraction;

	else if (!hasCrystalExtractionCommand && hasCrystalPredictionCommand)
		_executionMode = ExecutionMode::crystal_prediction;

	else
		throw std::runtime_error{ "Could not identify the execution mode." };
}

void Program::readInputFilePath()
{
	_inputFilePath = std::filesystem::path{ readCommandLineArgument(std::string{ "-i" }) };
	

	if (_inputFilePath.is_absolute())
	{
		if (!(System::IO::File::exist(_inputFilePath)))
		{
			std::string errorMessage;
			{
				errorMessage += "Could not find the file of \"";
				errorMessage += _inputFilePath.generic_string();
				errorMessage += "\".";
			}

			throw std::runtime_error{ errorMessage };
		}
	}

	else
	{
		std::string errorMessage;
		{
			errorMessage += "The path of \"";
			errorMessage += _inputFilePath.generic_string();
			errorMessage += "\" is not an absolute path.";
		}

		throw std::runtime_error{ errorMessage };
	}
}

// Private methods
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Private utility

std::string Program::readCommandLineArgument(const std::string& flag) const
{
	std::regex flagPat("[\\-\\=]{1}([\\-\\=[:alpha:]]+)");
	std::smatch flagSm;


	if (std::regex_match(flag, flagSm, flagPat))
	{
		std::string argumentText;
		{
			auto flagIter = _commandLineArgument.begin();
			{
				for (flagIter; flagIter != _commandLineArgument.end(); ++flagIter)
				{
					if ((*flagIter) == flag)
						break;
				}
			}

			if (flagIter != _commandLineArgument.end())
			{
				++flagIter;


				if (flagIter != _commandLineArgument.end())
				{
					std::smatch argumentSm;

					if (!(std::regex_match((*flagIter), argumentSm, flagPat)))
						argumentText = (*flagIter);
				}
			}
		}

		return argumentText;
	}

	else
		throw std::runtime_error{ "Argument flag is invalid." };
}

// Private utility
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
