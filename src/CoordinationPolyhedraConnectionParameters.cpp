#include "CoordinationPolyhedraConnectionParameters.h"

#include "InvalidOperationException.h"

#include "LengthCasting.h"

using namespace MathematicalCrystalChemistry::CrystalModel::Constraints::Internal;


// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Constructors

double CoordinationPolyhedraConnectionParameters::s_defaultAttractiveForceConstant{ 30.0 };
double CoordinationPolyhedraConnectionParameters::s_defaultRepulsiveForceConstant{ -100.0 };

CoordinationPolyhedraConnectionParameters::size_type CoordinationPolyhedraConnectionParameters::s_defaultMaxStructuralOptimizing{ 10000 };
double CoordinationPolyhedraConnectionParameters::s_defaultInitialMaxAtomicDisplacement{ MathToolkit::UnitConversion::LengthCasting::cast<MathToolkit::UnitConversion::LengthCasting::Unit::Angstrom, MathToolkit::UnitConversion::LengthCasting::Unit::AtomicUnit>(0.1) };
double CoordinationPolyhedraConnectionParameters::s_defaultFinalMaxAtomicDisplacement{ MathToolkit::UnitConversion::LengthCasting::cast<MathToolkit::UnitConversion::LengthCasting::Unit::Angstrom, MathToolkit::UnitConversion::LengthCasting::Unit::AtomicUnit>(0.001) };
double CoordinationPolyhedraConnectionParameters::s_defaultFeasibleGeometricalConstraintErrorRate{ 0.01 };



CoordinationPolyhedraConnectionParameters::CoordinationPolyhedraConnectionParameters() noexcept
	: _geometricalConstraintParameters{}
	, _molecularOptimizationParameters{}
{
}

// Constructors
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Methods

void CoordinationPolyhedraConnectionParameters::initialize() noexcept
{
	_geometricalConstraintParameters.initialize();
	_molecularOptimizationParameters.initialize();
	{
		_molecularOptimizationParameters.setPressure(0.0);
		_molecularOptimizationParameters.setAttractiveForceConstant(s_defaultAttractiveForceConstant);
		_molecularOptimizationParameters.setRepulsiveForceConstant(s_defaultRepulsiveForceConstant);

		_molecularOptimizationParameters.setMaxStructuralOptimizing(s_defaultMaxStructuralOptimizing);
		_molecularOptimizationParameters.setMaxAtomicDisplacements(s_defaultInitialMaxAtomicDisplacement, s_defaultFinalMaxAtomicDisplacement);
		_molecularOptimizationParameters.setInitialMaxUnitCellDisplacement(0.0);
		_molecularOptimizationParameters.setFeasibleGeometricalConstraintErrorRate(s_defaultFeasibleGeometricalConstraintErrorRate);
	}
}

void CoordinationPolyhedraConnectionParameters::initialize(const System::IO::StreamReader& streamReader)
{
	System::IO::StreamReader genericStreamReader = streamReader.getListBlock("&", "COORDINATION_POLYHEDRA_CONNECTION_PARAMETERS");
	{
		if (genericStreamReader.isEmpty())
			initialize();
		else
			_molecularOptimizationParameters.initialize(streamReader.getListBlock("&", "COORDINATION_POLYHEDRA_CONNECTION_PARAMETERS"), StructuralOptimizationParameters::OptimizationType::precise);
	}

	_geometricalConstraintParameters.initialize(streamReader.getListBlock("&", "GEOMETRICAL_CONSTRAINTS"));


	validateStructuralOptimizationParameters();
}

// Methods
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Private methods

void CoordinationPolyhedraConnectionParameters::validateStructuralOptimizationParameters() const
{
	if (std::numeric_limits<double>::epsilon() < std::abs(_molecularOptimizationParameters.pressure()))
		throw System::ExceptionServices::InvalidOperationException{ typeid(*this), "validateStructuralOptimizationParameters", "\"Pressure\" is not zero." };

	if (std::numeric_limits<double>::epsilon() < std::abs(_molecularOptimizationParameters.initialMaxUnitCellDisplacement()))
		throw System::ExceptionServices::InvalidOperationException{ typeid(*this), "validateStructuralOptimizationParameters", "Initial maximum unit cell displacement is not zero." };
}

// Private methods
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
