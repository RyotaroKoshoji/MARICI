#include "CrystalDesignRecorder.h"

#include "MpiPolicy.h"

#include "Directory.h"
#include "DirectoryNotFoundException.h"

using namespace MathematicalCrystalChemistry::Design::Diagnostics;


// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Constructors

std::mutex CrystalDesignRecorder::s_recordMutex;


CrystalDesignRecorder::DynamicAtom::DynamicAtom(const AtomicNumber number, const NumericalVector& coordinate) noexcept
	: _atomicNumber{ number }
	, _cartesianCoordinate{ coordinate }
{
}

CrystalDesignRecorder::CrystalDesignRecorder() noexcept
	: _crystalDesignRecordParameters{}
	, _mpiCrystalProductionDirectoryPath{}
	, _productionName{}
	, _mdStreamWriter{}
	, m_elapsedCount{ 0 }
	, m_mdRecordIntervalCount{ 0 }
{
}

CrystalDesignRecorder::CrystalDesignRecorder(const CrystalDesignRecordParameters& parameters)
	: _crystalDesignRecordParameters{ parameters }
	, _mpiCrystalProductionDirectoryPath{}
	, _productionName{}
	, _mdStreamWriter{}
	, m_elapsedCount{ 0 }
	, m_mdRecordIntervalCount{ 0 }
{
}

// Constructor
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Property

void CrystalDesignRecorder::setMpiCrystalProductionDirectoryPath(const std::filesystem::path& directoryPath)
{
	_mpiCrystalProductionDirectoryPath = directoryPath;
	{
		if (!(System::IO::Directory::exist(_mpiCrystalProductionDirectoryPath)))
		{
			std::string message;
			{
				message += "Could not find the directory of \"";
				message += _mpiCrystalProductionDirectoryPath.generic_string();
				message += "\".";
			}

			throw System::IO::DirectoryNotFoundException{ typeid(*this), "constructor", message };
		}
	}
}

void CrystalDesignRecorder::setProductionName(const std::string& name)
{
	if (name.empty())
		throw System::ExceptionServices::ArgumentOutOfRangeException{ typeid(*this), "setProductionName", "Argument name is empty." };

	else
	{
		_productionName = name;
		m_elapsedCount = 0;
		m_mdRecordIntervalCount = 0;

		std::filesystem::path mdFilePath = _mpiCrystalProductionDirectoryPath;
		mdFilePath /= _productionName;
		System::IO::Directory::createDirectory(mdFilePath, System::IO::Directory::CreateOptions::skip_existing);

		mdFilePath /= "optimizationProcess";
		mdFilePath += DftToolkit::Openmx::IO::OpenmxMdStreamWriter::correctExtension();
		_mdStreamWriter = DftToolkit::Openmx::IO::OpenmxMdStreamWriter{ mdFilePath, System::IO::FileStream::FileMode::create };
	}
}

// Property
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Methods

void CrystalDesignRecorder::record(const ObjectiveCrystalStructure& crystalStructure)
{
	++m_mdRecordIntervalCount;

	if (m_mdRecordIntervalCount < _crystalDesignRecordParameters.mdRecordFrequency())
		++m_elapsedCount;

	else
	{
		ChemToolkit::Crystallography::CrystalStructure<DynamicAtom> dynamicStructure{ crystalStructure.unitCell() };
		{
			for (size_type index = 0; index < crystalStructure.atoms().size(); ++index)
				dynamicStructure.atoms().push_back(DynamicAtom{ crystalStructure.correspondingIonicAtomicNumbers()[index].atomicNumber(), crystalStructure.atoms()[index].cartesianCoordinate()});
		}

		_mdStreamWriter.record(dynamicStructure, ++m_elapsedCount);
		m_mdRecordIntervalCount = 0;
	}
}

void CrystalDesignRecorder::record(const ObjectiveMolecularStructure& molecularStructure)
{
	++m_mdRecordIntervalCount;

	if (m_mdRecordIntervalCount < _crystalDesignRecordParameters.mdRecordFrequency())
		++m_elapsedCount;

	else
	{
		ChemToolkit::Crystallography::CrystalStructure<DynamicAtom> dynamicStructure{ molecularStructure.unitCell() };
		{
			for (size_type index = 0; index < molecularStructure.atoms().size(); ++index)
				dynamicStructure.atoms().push_back(DynamicAtom{ molecularStructure.correspondingIonicAtomicNumbers()[index].atomicNumber(), molecularStructure.atoms()[index].cartesianCoordinate() });
		}

		_mdStreamWriter.record(dynamicStructure, ++m_elapsedCount);
		m_mdRecordIntervalCount = 0;
	}
}

void CrystalDesignRecorder::forceRecord(const ObjectiveCrystalStructure& crystalStructure)
{
	ChemToolkit::Crystallography::CrystalStructure<DynamicAtom> dynamicStructure{ crystalStructure.unitCell() };
	{
		for (size_type index = 0; index < crystalStructure.atoms().size(); ++index)
			dynamicStructure.atoms().push_back(DynamicAtom{ crystalStructure.correspondingIonicAtomicNumbers()[index].atomicNumber(), crystalStructure.atoms()[index].cartesianCoordinate() });
	}

	_mdStreamWriter.record(dynamicStructure, ++m_elapsedCount);
	m_mdRecordIntervalCount = 0;
}

void CrystalDesignRecorder::forceRecord(const ObjectiveMolecularStructure& molecularStructure)
{
	ChemToolkit::Crystallography::CrystalStructure<DynamicAtom> dynamicStructure{ molecularStructure.unitCell() };
	{
		for (size_type index = 0; index < molecularStructure.atoms().size(); ++index)
			dynamicStructure.atoms().push_back(DynamicAtom{ molecularStructure.correspondingIonicAtomicNumbers()[index].atomicNumber(), molecularStructure.atoms()[index].cartesianCoordinate() });
	}

	_mdStreamWriter.record(dynamicStructure, ++m_elapsedCount);
	m_mdRecordIntervalCount = 0;
}

// Methods
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
