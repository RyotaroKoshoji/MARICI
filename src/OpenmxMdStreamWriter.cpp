#include "OpenmxMdStreamWriter.h"

#include "LengthCasting.h"
#include "TimeCasting.h"

using namespace DftToolkit::Openmx::IO;


// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Constructors

OpenmxMdStreamWriter::OpenmxMdStreamWriter() noexcept
	: FileStream{}
	, m_frameNumber{ 0 }
	, m_elapsedCount{ 0 }
	, m_elapsedTime{ 0.0 }
{
}

OpenmxMdStreamWriter::OpenmxMdStreamWriter(const std::filesystem::path& mdFilePath, const FileMode& fileMode)
	: FileStream{ mdFilePath, fileMode }
	, m_frameNumber{ 0 }
	, m_elapsedCount{ 0 }
	, m_elapsedTime{ 0.0 }
{
	if (!(FileStream::canWrite()))
		throw System::ExceptionServices::ArgumentOutOfRangeException{ typeid(*this), "constructor", "File mode is not writable." };

	if (!(isCorrectExtension(filePath())))
	{
		std::string errorMessage;
		{
			errorMessage += "The extension of \"";
			errorMessage += filePath().generic_string();
			errorMessage += "\" is not \"";
			errorMessage += correctExtension();
			errorMessage += "\".";
		}

		throw System::ExceptionServices::ArgumentOutOfRangeException{ typeid(*this), "constructor", errorMessage };
	}
}

// Constructors
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Private methods

void OpenmxMdStreamWriter::writeElapsedTime(const double elapsedTime, StreamWriter& streamWriter) const
{
	using MathToolkit::UnitConversion::TimeCasting::Unit::AtomicUnit;
	using FemtoSecond = MathToolkit::UnitConversion::TimeCasting::Unit::Second<std::femto>;

	streamWriter.write("  time=  ");
	streamWriter.write(elapsedTime * MathToolkit::UnitConversion::TimeCasting::getScalingMultiplier<AtomicUnit, FemtoSecond>());
	streamWriter.write(" (fs)  ");
}

void OpenmxMdStreamWriter::writeUnitCell(const NumericalMatrix& basisVectors, StreamWriter& streamWriter) const
{
	streamWriter.write("Cell_Vectors=");

	for (unsigned int columnIndex = 0; columnIndex < 3; ++columnIndex)
	{
		using MathToolkit::UnitConversion::LengthCasting::Unit::Angstrom;
		using MathToolkit::UnitConversion::LengthCasting::Unit::AtomicUnit;

		streamWriter.write("  ");
		streamWriter.write(basisVectors(0, columnIndex) * MathToolkit::UnitConversion::LengthCasting::getScalingMultiplier<AtomicUnit, Angstrom>());
		streamWriter.write("  ");
		streamWriter.write(basisVectors(1, columnIndex) * MathToolkit::UnitConversion::LengthCasting::getScalingMultiplier<AtomicUnit, Angstrom>());
		streamWriter.write("  ");
		streamWriter.write(basisVectors(2, columnIndex) * MathToolkit::UnitConversion::LengthCasting::getScalingMultiplier<AtomicUnit, Angstrom>());
	}

	streamWriter.breakLine();
}

// Private methods
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Private utility

void OpenmxMdStreamWriter::writeCartesianCoordinate(const NumericalVector& cartesianCoordinate, StreamWriter& streamWriter) const
{
	using MathToolkit::UnitConversion::LengthCasting::Unit::Angstrom;
	using MathToolkit::UnitConversion::LengthCasting::Unit::AtomicUnit;


	streamWriter.write(cartesianCoordinate[0] * MathToolkit::UnitConversion::LengthCasting::getScalingMultiplier<AtomicUnit, Angstrom>());
	streamWriter.write("  ");
	streamWriter.write(cartesianCoordinate[1] * MathToolkit::UnitConversion::LengthCasting::getScalingMultiplier<AtomicUnit, Angstrom>());
	streamWriter.write("  ");
	streamWriter.write(cartesianCoordinate[2] * MathToolkit::UnitConversion::LengthCasting::getScalingMultiplier<AtomicUnit, Angstrom>());
}

// Private utility
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
