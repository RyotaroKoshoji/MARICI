#include "CoordinationPolyhedraConnector.h"

#include <algorithm>

#include "MoleculeOptimizer.h"

#include "AtomicRadiusDictionary.h"
#include "CoordinationConstraintsDictionary.h"

using namespace MathematicalCrystalChemistry::CrystalModel::Constraints::Internal;


// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Constructors

CoordinationPolyhedraConnector::CoordinationPolyhedraConnector() noexcept
	: PolyhedralFeasibilityCheckerBase{}
	, m_randomEngine{}
	, m_distributor{ -1.0, 1.0 }
{
	std::random_device seedGen;
	m_randomEngine = std::mt19937{ seedGen() };
}

// Constructors
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Methods

CoordinationPolyhedraConnector::FeasibleLinkingDictionary CoordinationPolyhedraConnector::getFeasibleLinkingDictionary(const ConstrainingChemicalComposition& crystalComposition) const
{
	FeasibleLinkingDictionary feasibleLinkingDictionary;
	{
		for (auto formerIter = crystalComposition.begin(); formerIter != crystalComposition.end(); ++formerIter)
		{
			for (auto latterIter = formerIter; latterIter != crystalComposition.end(); ++latterIter)
			{
				if (formerIter == latterIter)
				{
					if (1 < formerIter->second)
					{
						std::vector<BasicChemicalComposition> feasibleBridgingCompositions = getFeasibleBridgingCompositions(formerIter->first, latterIter->first, crystalComposition);

						if (!(feasibleBridgingCompositions.empty()))
						{
							std::pair<IonicAtomicNumber, IonicAtomicNumber> ionicAtomicNumberPair = getIonicAtomicNumberKey(formerIter->first, latterIter->first);
							feasibleLinkingDictionary.emplace(ionicAtomicNumberPair, std::move(feasibleBridgingCompositions));
						}
					}
				}

				else
				{
					std::vector<BasicChemicalComposition> feasibleBridgingCompositions = getFeasibleBridgingCompositions(formerIter->first, latterIter->first, crystalComposition);

					if (!(feasibleBridgingCompositions.empty()))
					{
						std::pair<IonicAtomicNumber, IonicAtomicNumber> ionicAtomicNumberPair = getIonicAtomicNumberKey(formerIter->first, latterIter->first);
						feasibleLinkingDictionary.emplace(ionicAtomicNumberPair, std::move(feasibleBridgingCompositions));
					}
				}
			}
		}
	}

	return feasibleLinkingDictionary;
}

// Methods
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Private methods

std::vector<CoordinationPolyhedraConnector::BasicChemicalComposition> CoordinationPolyhedraConnector::getFeasibleBridgingCompositions(const ConstrainingAtomicSpecies& formerAtomicSpecies, const ConstrainingAtomicSpecies& latterAtomicSpecies, const ConstrainingChemicalComposition& crystalComposition) const
{
	ConstrainingMolecularStructure constrainingMolecularStructure;
	MathematicalCrystalChemistry::Design::Optimization::MoleculeOptimizer moleculeOptimizer{ _coordinationPolyhedraConnectionParameters.molecularOptimizationParameters(), _coordinationPolyhedraConnectionParameters.geometricalConstraintParameters() };


	std::vector<BasicChemicalComposition> feasibleBridgingCompositions;
	{
		for (const auto& basicBridgingComposition : getPossibleBridgingCompositionDictionary(formerAtomicSpecies.coordinationConstraints().feasibleCompositions(), latterAtomicSpecies.coordinationConstraints().feasibleCompositions()))
		{
			ConstrainingChemicalComposition constrainingBridgingComposition = toConstrainingChemicalComposition(basicBridgingComposition, crystalComposition);

			initializeConstrainingMolecularStructure(constrainingMolecularStructure, formerAtomicSpecies, latterAtomicSpecies, constrainingBridgingComposition);
			{
				constrainingMolecularStructure.setFeasibleErrorRate(_coordinationPolyhedraConnectionParameters.molecularOptimizationParameters().feasibleGeometricalConstraintErrorRate());
				constrainingMolecularStructure.setExclusiveRadiusRatio(_coordinationPolyhedraConnectionParameters.geometricalConstraintParameters().minimumExclusionDistanceRatio());
				constrainingMolecularStructure.setInteratomicDistanceTracerCutoffRatio(_coordinationPolyhedraConnectionParameters.geometricalConstraintParameters().interatomicDistanceTracerCutoffRatio());
				constrainingMolecularStructure.setInteratomicDistanceConstrainerCutoffRatio(_coordinationPolyhedraConnectionParameters.geometricalConstraintParameters().interatomicDistanceConstrainerCutoffRatio());
				constrainingMolecularStructure.updateTracingIndexPairs();
				constrainingMolecularStructure.createInteratomicDistanceConstraints();
			}


			ObjectiveMolecularStructure objectiveMolecularStructure{ constrainingMolecularStructure };
			moleculeOptimizer.execute(objectiveMolecularStructure);


			if (objectiveMolecularStructure.isFeasible(_coordinationPolyhedraConnectionParameters.molecularOptimizationParameters().feasibleGeometricalConstraintErrorRate(), _coordinationPolyhedraConnectionParameters.geometricalConstraintParameters().minimumExclusionDistanceRatio()))
				feasibleBridgingCompositions.push_back(std::move(basicBridgingComposition));
		}
	}

	return feasibleBridgingCompositions;
}

// Private methods
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Private utility

std::set<CoordinationPolyhedraConnector::BasicChemicalComposition> CoordinationPolyhedraConnector::getPossibleBridgingCompositionDictionary(const std::set<BasicChemicalComposition>& formerFeasibleCompositionDictionary, const std::set<BasicChemicalComposition>& latterFeasibleCompositionDictionary) const
{
	std::set<BasicChemicalComposition> possibleBridgingCompositionDictionary;
	{
		for (const auto& formerFeasibleComposition : formerFeasibleCompositionDictionary)
		{
			for (const auto& latterFeasibleComposition : latterFeasibleCompositionDictionary)
			{
				BasicChemicalComposition maximumCommonBridgingComposition;
				{
					for (const auto& formerNumAndCount : formerFeasibleComposition)
					{
						size_type latterCount = latterFeasibleComposition.count(formerNumAndCount.first);

						if (0 < latterCount)
							maximumCommonBridgingComposition.add(formerNumAndCount.first, std::min(formerNumAndCount.second, latterCount));
					}
				}

				BasicChemicalComposition bridgingComposition;
				initializeBridgingComposition(bridgingComposition, maximumCommonBridgingComposition);
				{
					possibleBridgingCompositionDictionary.emplace(bridgingComposition);

					while (advanceBridgingComposition(bridgingComposition, maximumCommonBridgingComposition))
						possibleBridgingCompositionDictionary.emplace(bridgingComposition);
				}
			}
		}
	}

	return possibleBridgingCompositionDictionary;
}

void CoordinationPolyhedraConnector::initializeConstrainingMolecularStructure(ConstrainingMolecularStructure& constrainingMolecularStructure, const ConstrainingAtomicSpecies& formerAtomicSpecies, const ConstrainingAtomicSpecies& latterAtomicSpecies, const ConstrainingChemicalComposition& bridgingComposition) const
{
	std::vector<ConstrainingAtom> constrainingAtoms;
	{
		constrainingAtoms.push_back(ConstrainingAtom{ formerAtomicSpecies });
		constrainingAtoms.back().cartesianCoordinate()[0] -= getRepresentativeRadius(constrainingAtoms.back());

		constrainingAtoms.push_back(ConstrainingAtom{ latterAtomicSpecies });
		constrainingAtoms.back().cartesianCoordinate()[0] += getRepresentativeRadius(constrainingAtoms.back());


		for (const auto& speciesAndCount : bridgingComposition)
		{
			for (size_type rep = 0; rep < speciesAndCount.second; ++rep)
			{
				constrainingAtoms.push_back(ConstrainingAtom{ speciesAndCount.first });
				constrainingAtoms.back().cartesianCoordinate()[1] += getRepresentativeRadius(constrainingAtoms.back()) * m_distributor(m_randomEngine);
				constrainingAtoms.back().cartesianCoordinate()[2] += getRepresentativeRadius(constrainingAtoms.back()) * m_distributor(m_randomEngine);
			}
		}
	}


	constrainingMolecularStructure.initialize(std::move(constrainingAtoms));
}

// Private utility
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
