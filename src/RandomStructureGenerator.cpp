#include "RandomStructureGenerator.h"

#include <cmath>

#include "MathConstants.h"

using namespace MathematicalCrystalChemistry::Design::Generation;


// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Constructors

RandomStructureGenerator::RandomStructureGenerator() noexcept
	: _randomStructureGenerationParameters{}
	, _generatingComposition{}
	, m_randomEngine{}
	, m_latticeLengthGenerator{}
	, m_latticeAngleGenerator{}
	, m_fractionalCoordinateGenerator{ 0.0, 1.0 }
	, m_outputUnitCellVolume{ 1.0 }
{
	std::random_device seedGen;
	m_randomEngine = std::mt19937{ seedGen() };
}

RandomStructureGenerator::RandomStructureGenerator(const RandomStructureGenerationParameters& parameters)
	: _randomStructureGenerationParameters{ parameters }
	, _generatingComposition{}
	, m_randomEngine{}
	, m_latticeLengthGenerator{ 1.0, parameters.maxInitialLatticeLengthRatio() }
	, m_latticeAngleGenerator{ parameters.minInitialLatticeAngle(), parameters.maxInitialLatticeAngle() }
	, m_fractionalCoordinateGenerator{ 0.0, 1.0 }
	, m_outputUnitCellVolume{ 1.0 }
{
	std::random_device seedGen;
	m_randomEngine = std::mt19937{ seedGen() };
}

// Constructors
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Methods

void RandomStructureGenerator::next(ConstrainingCrystalStructure& constrainingCrystalStructure) const
{
	ChemToolkit::Crystallography::UnitCell unitCell;
	{
		ChemToolkit::Crystallography::UnitCell::LatticeParameters latticeParameters;
		{
			latticeParameters.lengths.a = 1.0;
			latticeParameters.lengths.b = m_latticeLengthGenerator(m_randomEngine);
			latticeParameters.lengths.c = m_latticeLengthGenerator(m_randomEngine);

			latticeParameters.angles.alpha = m_latticeAngleGenerator(m_randomEngine);
			latticeParameters.angles.beta = m_latticeAngleGenerator(m_randomEngine);
			latticeParameters.angles.gamma = m_latticeAngleGenerator(m_randomEngine);
		}
		unitCell = ChemToolkit::Crystallography::UnitCell{ latticeParameters };


		double scalingMultiplier = 1.0;
		{
			double generatedVolume = unitCell.getCellVolume();
			scalingMultiplier = std::pow((m_outputUnitCellVolume / generatedVolume), 0.333333333333333);
		}

		unitCell.basisVectors() *= scalingMultiplier;
	}


	std::vector<ConstrainingAtom> atomicArrangement;
	{
		for (const auto& speciesAndCount : _generatingComposition)
		{
			for (size_type index = 0; index < speciesAndCount.second; ++index)
			{
				NumericalVector fractionalCoordinate(3);
				{
					fractionalCoordinate[0] = m_fractionalCoordinateGenerator(m_randomEngine);
					fractionalCoordinate[1] = m_fractionalCoordinateGenerator(m_randomEngine);
					fractionalCoordinate[2] = m_fractionalCoordinateGenerator(m_randomEngine);
				}

				ConstrainingAtom constrainingAtom{ speciesAndCount.first, (unitCell.basisVectors() * fractionalCoordinate) };
				atomicArrangement.push_back(std::move(constrainingAtom));
			}
		}
	}


	constrainingCrystalStructure.initialize(unitCell, std::move(atomicArrangement));
}

// Methods
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Private methods

void RandomStructureGenerator::updateOutputUnitCellVolume() const
{
	double sphericalPackingsVolume = 0.0;
	{
		for (const auto& speciesAndCount : _generatingComposition)
		{
			double sphericalVolume = 1.33333333333333;
			{
				double sphericalRadius = 0.0;
				{
					if (speciesAndCount.first.ionicAtomicNumber().formalCharge().isAnion() || speciesAndCount.first.ionicAtomicNumber().formalCharge().isCation())
						sphericalRadius = speciesAndCount.first.ionicRadius().maximum();
					else
						sphericalRadius = speciesAndCount.first.covalentRadius().maximum();
				}

				sphericalVolume *= sphericalRadius;
				sphericalVolume *= sphericalRadius;
				sphericalVolume *= sphericalRadius;
				sphericalVolume *= static_cast<double>(speciesAndCount.second);
			}

			sphericalPackingsVolume += sphericalVolume;
		}
	}


	m_outputUnitCellVolume = sphericalPackingsVolume / _randomStructureGenerationParameters.initialPackingFraction();
}

// Private methods
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
