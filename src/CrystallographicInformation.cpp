#include "CrystallographicInformation.h"

#include "StreamWriter.h"

#include "CrystallographicStructure.h"

using namespace ChemToolkit::Crystallography;


// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Constructor

CrystallographicInformation::CrystallographicInformation() noexcept
	: _structureName{}
	, _unitCell{}
	, _atomSites{}
	, _spaceGroupNumber{}
	, _symmetryOperations{}
{
}

// Constructor
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Methods

CrystallographicStructure<CrystallographicAtom> CrystallographicInformation::toCrystallographicStructure() const
{
	std::vector<CrystallographicAtom> atoms;
	{
		if (_symmetryOperations.empty())
			throw System::ExceptionServices::InvalidOperationException{ typeid(*this), "toCrystallographicStructure", "Symmetry operations are empty." };
		else
		{
			for (const auto& atomSite : _atomSites)
			{
				for (const auto& symmetryOperation : _symmetryOperations)
				{
					CrystallographicAtom crystallographicAtom{ ChemToolkit::Generic::IonicAtomicNumber{ atomSite.atomicNumber(), atomSite.formalCharge() } };
					{
						NumericalVector fractionalCoordinate = symmetryOperation(atomSite.fractionalCoordinate());
						fractionalCoordinate[0] -= std::floor(fractionalCoordinate[0]);
						fractionalCoordinate[1] -= std::floor(fractionalCoordinate[1]);
						fractionalCoordinate[2] -= std::floor(fractionalCoordinate[2]);

						crystallographicAtom.cartesianCoordinate() = (_unitCell.basisVectors() * fractionalCoordinate);
					}

					bool isNewAtom = true;
					{
						for (const auto& registerdAtom : atoms)
						{
							if (isSameAtom(crystallographicAtom, registerdAtom, symmetryOperation.precision()))
							{
								isNewAtom = false;
								break;
							}
						}
					}


					if (isNewAtom)
						atoms.push_back(std::move(crystallographicAtom));
				}
			}
		}
	}


	return CrystallographicStructure<CrystallographicAtom>{ _unitCell, std::move(atoms) };
}

// Methods
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
