#include "MoleculeOptimizer.h"

#include <cmath>

using namespace MathematicalCrystalChemistry::Design::Optimization;


// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Constructors

MoleculeOptimizer::MoleculeOptimizer() noexcept
	: _structuralOptimizationParameters{}
	, _exclusiveRadiusRatio{ 1.0 }
	, m_inverseBasisVectors{ MathToolkit::LinearAlgebra::getIdentityMatrix<double, 3>() }
{
}

MoleculeOptimizer::MoleculeOptimizer(const StructuralOptimizationParameters& structural, const GeometricalConstraintParameters& geometrical)
	: _structuralOptimizationParameters{ structural }
	, _exclusiveRadiusRatio{ geometrical.minimumExclusionDistanceRatio() }
	, m_inverseBasisVectors{ MathToolkit::LinearAlgebra::getIdentityMatrix<double, 3>() }
{
}

// Constructors
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Methods

void MoleculeOptimizer::execute(ObjectiveMolecularStructure& structure) const
{
	double maxAtomicDisplacement = _structuralOptimizationParameters.initialMaxAtomicDisplacement();
	double maxUnitCellDisplacement = _structuralOptimizationParameters.initialMaxUnitCellDisplacement();


	for (size_type structuralOptimizing = 0; structuralOptimizing < _structuralOptimizationParameters.maxStructuralOptimizing(); ++structuralOptimizing)
	{
		m_inverseBasisVectors = structure.unitCell().getInverseBasisVectors();
		applyForces(structure);


		for (auto& atom : structure.atoms())
			atom.move(maxAtomicDisplacement);


		maxAtomicDisplacement *= _structuralOptimizationParameters.displacementDecreasingFactor();
		maxUnitCellDisplacement *= _structuralOptimizationParameters.displacementDecreasingFactor();
	}
}

void MoleculeOptimizer::execute(ObjectiveMolecularStructure& structure, CrystalDesignRecorder& recorder) const
{
	double maxAtomicDisplacement = _structuralOptimizationParameters.initialMaxAtomicDisplacement();
	double maxUnitCellDisplacement = _structuralOptimizationParameters.initialMaxUnitCellDisplacement();


	for (size_type structuralOptimizing = 0; structuralOptimizing < _structuralOptimizationParameters.maxStructuralOptimizing(); ++structuralOptimizing)
	{
		m_inverseBasisVectors = structure.unitCell().getInverseBasisVectors();
		applyForces(structure);


		for (auto& atom : structure.atoms())
			atom.move(maxAtomicDisplacement);


		maxAtomicDisplacement *= _structuralOptimizationParameters.displacementDecreasingFactor();
		maxUnitCellDisplacement *= _structuralOptimizationParameters.displacementDecreasingFactor();

		recorder.record(structure);
	}
}

// Methods
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Private methods

void MoleculeOptimizer::applyForces(ObjectiveMolecularStructure& structure) const noexcept
{
	for (const auto& indices : structure.covalentBondedIndices())
		applyCovalentBondingForce(indices, structure);

	for (const auto& indices : structure.covalentExcludedIndices())
		applyCovalentExcludingForce(indices, structure);

	for (const auto& indices : structure.ionicBondedIndices())
		applyIonicBondingForce(indices, structure);

	for (const auto& indices : structure.ionicExcludedIndices())
		applyIonicExcludingForce(indices, structure);

	for (const auto& indices : structure.ionicRepulsedIndices())
		applyIonicRepulsingForce(indices, structure);
}

// Private methods
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
