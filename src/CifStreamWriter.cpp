#include "CifStreamWriter.h"

#include "DateTime.h"

#include "AngleCasting.h"
#include "LengthCasting.h"

using namespace ChemToolkit::Crystallography::IO;


// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Constructors

CifStreamWriter::CifStreamWriter(const std::filesystem::path& cifFilePath, const FileMode& fileMode)
	: FileStream{ cifFilePath, fileMode }
{
	if (!(FileStream::canWrite()))
		throw System::ExceptionServices::ArgumentOutOfRangeException{ typeid(*this), "constructor", "File mode is not writable." };

	if (!(isCorrectExtension(filePath())))
	{
		std::string errorMessage;
		{
			errorMessage += "The extension of \"";
			errorMessage += filePath().generic_string();
			errorMessage += "\" is not \"";
			errorMessage += correctExtension();
			errorMessage += "\".";
		}

		throw System::ExceptionServices::ArgumentOutOfRangeException{ typeid(*this), "constructor", errorMessage };
	}
}

// Constructors
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Private methods

void CifStreamWriter::writeCreationDate(StreamWriter& streamWriter) const
{
	streamWriter.write("_audit_creation_date	");
	streamWriter.writeLine(System::Utility::DateTime::toTimeString(System::Utility::DateTime::getNowTime()));
}

void CifStreamWriter::writeUnitCell(StreamWriter& streamWriter, const CrystallographicInformation& crystallographicInformation) const
{
	using MathToolkit::UnitConversion::LengthCasting::Unit::AtomicUnit;
	using MathToolkit::UnitConversion::LengthCasting::Unit::Angstrom;
	using MathToolkit::UnitConversion::AngleCasting::Unit::Degree;
	using MathToolkit::UnitConversion::AngleCasting::Unit::Radian;

	constexpr double angleScalingMultiplier = MathToolkit::UnitConversion::AngleCasting::getScalingMultiplier<Radian, Degree>();
	constexpr double lengthScalingMultiplier = MathToolkit::UnitConversion::LengthCasting::getScalingMultiplier<AtomicUnit, Angstrom>();
	ChemToolkit::Crystallography::UnitCell::LatticeParameters latticeParameters = crystallographicInformation.unitCell().getLatticeParameters();


	streamWriter.write("_cell_length_a			");
	streamWriter.writeLine(lengthScalingMultiplier * latticeParameters.lengths.a);
	streamWriter.write("_cell_length_b			");
	streamWriter.writeLine(lengthScalingMultiplier * latticeParameters.lengths.b);
	streamWriter.write("_cell_length_c			");
	streamWriter.writeLine(lengthScalingMultiplier * latticeParameters.lengths.c);

	streamWriter.write("_cell_angle_alpha		");
	streamWriter.writeLine(angleScalingMultiplier * latticeParameters.angles.alpha);
	streamWriter.write("_cell_angle_beta		");
	streamWriter.writeLine(angleScalingMultiplier * latticeParameters.angles.beta);
	streamWriter.write("_cell_angle_gamma		");
	streamWriter.writeLine(angleScalingMultiplier * latticeParameters.angles.gamma);

	const double volumeMultiplier = (lengthScalingMultiplier * lengthScalingMultiplier * lengthScalingMultiplier);
	streamWriter.write("_cell_volume		");
	streamWriter.writeLine(volumeMultiplier * crystallographicInformation.unitCell().getCellVolume());
}

// Private methods
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
