#include "CrystalPredictionTask.h"

#include <regex>

#include "FileStream.h"
#include "InvalidFileException.h"

using namespace MathematicalCrystalChemistry::Prediction;


// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Constructors

CrystalPredictionTask::CrystalPredictionTask() noexcept
	: _crystalDesignRequest{}
	, _crystalProductionReportParameters{}
	, _crystalDesignParameters{}
{
}

// Constructors
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Methods

void CrystalPredictionTask::initialize() noexcept
{
	_crystalDesignRequest.clear();

	_crystalProductionReportParameters.initialize();
	_crystalDesignParameters.initialize();
}

void CrystalPredictionTask::initialize(const System::IO::StreamReader& streamReader)
{
	_crystalProductionReportParameters.initialize(streamReader);
	_crystalDesignParameters.initialize(streamReader);

	initializeCrystalDesignRequest(streamReader);
}

// Methods
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Private methods

void CrystalPredictionTask::initializeCrystalDesignRequest(const System::IO::StreamReader& streamReader)
{
	_crystalDesignRequest.clear();

	std::regex totalPat{ "[\\s\\t]*([[:alpha:]]+[\\+\\-\\d]*[\\_]{1}[\\d]+[\\s\\t]+)+([\\d]+)[\\s\\t]*" };
	System::IO::StreamReader compositionReader = streamReader.getListBlock("&", "CRYSTAL_STRUCTURE_PREDICTION");


	for (const auto& stringLine : compositionReader.allLines())
	{
		std::smatch totalSm;

		if (std::regex_match(stringLine, totalSm, totalPat))
		{
			ChemicalComposition chemicalComposition;
			size_type randomProducing = static_cast<size_type>(std::stoi(totalSm.str(2)));

			std::regex pat{ "([[:alpha:]]+[\\+\\-\\d]*[\\_]{1}[\\d]+)" };
			{
				for (std::sregex_iterator iter(stringLine.begin(), stringLine.end(), pat); iter != std::sregex_iterator{}; ++iter)
				{
					auto addingComposition = toChemicalComposition(iter->str(1));
					chemicalComposition.add(addingComposition.first, addingComposition.second);
				}
			}

			_crystalDesignRequest.emplace(chemicalComposition, randomProducing);
		}

		else
			throw System::IO::InvalidFileException{ typeid(*this), "initialize", "There is an invalid chemical composition request." };
	}
}

// Private methods
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Private utility

std::pair<CrystalPredictionTask::ConstrainingAtomicSpecies, CrystalPredictionTask::ConstrainingAtomicSpecies::size_type> CrystalPredictionTask::toChemicalComposition(const std::string& compositionTexts) const
{
	using ChemToolkit::Generic::IonicAtomicNumber;

	std::regex elementPat("([[:alpha:]]+)[\\_]{1}([\\d]+)");
	std::regex anionPatA("([[:alpha:]]+)[\\-]{1}[\\_]{1}([\\d]+)");
	std::regex anionPatB("([[:alpha:]]+)([\\d]+)[\\-]{1}[\\_]{1}([\\d]+)");
	std::regex cationPatA("([[:alpha:]]+)[\\+]{1}[\\_]{1}([\\d]+)");
	std::regex cationPatB("([[:alpha:]]+)([\\d]+)[\\+]{1}[\\_]{1}([\\d]+)");


	for (std::sregex_iterator iter(compositionTexts.begin(), compositionTexts.end(), elementPat); iter != std::sregex_iterator{}; ++iter)
	{
		ChemToolkit::Generic::ElementSymbol elementSymbol{ iter->str(1) };
		ConstrainingAtomicSpecies::size_type numAtoms = static_cast<ConstrainingAtomicSpecies::size_type>(std::stoi(iter->str(2)));

		if (0 < numAtoms)
			return std::make_pair(ConstrainingAtomicSpecies{ IonicAtomicNumber{ elementSymbol.toAtomicNumber(), 0 } }, numAtoms);
		else
			throw System::ExceptionServices::ArgumentOutOfRangeException{ "MathematicalCrystalChemistry::Design::CrystalPredictionTask::toChemicalComposition", "There is a zero composition." };
	}

	for (std::sregex_iterator iter(compositionTexts.begin(), compositionTexts.end(), anionPatA); iter != std::sregex_iterator{}; ++iter)
	{
		ChemToolkit::Generic::ElementSymbol elementSymbol{ iter->str(1) };
		ConstrainingAtomicSpecies::charge_type formalCharge = (-1);
		ConstrainingAtomicSpecies::size_type numAtoms = static_cast<ConstrainingAtomicSpecies::size_type>(std::stoi(iter->str(2)));


		if (0 < numAtoms)
			return std::make_pair(ConstrainingAtomicSpecies{ IonicAtomicNumber{ elementSymbol.toAtomicNumber(), formalCharge } }, numAtoms);
		else
			throw System::ExceptionServices::ArgumentOutOfRangeException{ "MathematicalCrystalChemistry::Design::CrystalPredictionTask::toChemicalComposition", "There is a zero composition." };
	}

	for (std::sregex_iterator iter(compositionTexts.begin(), compositionTexts.end(), anionPatB); iter != std::sregex_iterator{}; ++iter)
	{
		ChemToolkit::Generic::ElementSymbol elementSymbol{ iter->str(1) };
		ConstrainingAtomicSpecies::charge_type formalCharge = static_cast<ConstrainingAtomicSpecies::charge_type>((-1) * std::stoi(iter->str(2)));
		ConstrainingAtomicSpecies::size_type numAtoms = static_cast<ConstrainingAtomicSpecies::size_type>(std::stoi(iter->str(3)));


		if (0 < numAtoms)
			return std::make_pair(ConstrainingAtomicSpecies{ IonicAtomicNumber{ elementSymbol.toAtomicNumber(), formalCharge } }, numAtoms);
		else
			throw System::ExceptionServices::ArgumentOutOfRangeException{ "MathematicalCrystalChemistry::Design::CrystalPredictionTask::toChemicalComposition", "There is a zero composition." };
	}

	for (std::sregex_iterator iter(compositionTexts.begin(), compositionTexts.end(), cationPatA); iter != std::sregex_iterator{}; ++iter)
	{
		ChemToolkit::Generic::ElementSymbol elementSymbol{ iter->str(1) };
		ConstrainingAtomicSpecies::charge_type formalCharge = 1;
		ConstrainingAtomicSpecies::size_type numAtoms = static_cast<ConstrainingAtomicSpecies::size_type>(std::stoi(iter->str(2)));


		if (0 < numAtoms)
			return std::make_pair(ConstrainingAtomicSpecies{ IonicAtomicNumber{ elementSymbol.toAtomicNumber(), formalCharge } }, numAtoms);
		else
			throw System::ExceptionServices::ArgumentOutOfRangeException{ "MathematicalCrystalChemistry::Design::CrystalPredictionTask::toChemicalComposition", "There is a zero composition." };
	}

	for (std::sregex_iterator iter(compositionTexts.begin(), compositionTexts.end(), cationPatB); iter != std::sregex_iterator{}; ++iter)
	{
		ChemToolkit::Generic::ElementSymbol elementSymbol{ iter->str(1) };
		ConstrainingAtomicSpecies::charge_type formalCharge = static_cast<ConstrainingAtomicSpecies::charge_type>(std::stoi(iter->str(2)));
		ConstrainingAtomicSpecies::size_type numAtoms = static_cast<ConstrainingAtomicSpecies::size_type>(std::stoi(iter->str(3)));


		if (0 < numAtoms)
			return std::make_pair(ConstrainingAtomicSpecies{ IonicAtomicNumber{ elementSymbol.toAtomicNumber(), formalCharge } }, numAtoms);
		else
			throw System::ExceptionServices::ArgumentOutOfRangeException{ "MathematicalCrystalChemistry::Design::CrystalPredictionTask::toChemicalComposition", "There is a zero composition." };
	}


	throw System::ExceptionServices::ArgumentOutOfRangeException{ "MathematicalCrystalChemistry::Design::CrystalPredictionTask::toChemicalComposition", "Could not read composition." };
}

// Private utility
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
