#include "ThreadingPolicy.h"

#include <thread>
#include <mkl_service.h>

#include "ArgumentOutOfRangeException.h"

using namespace System::Parallel;


// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Static members

ThreadingPolicy::size_type ThreadingPolicy::s_maxThreading = std::thread::hardware_concurrency();
ThreadingPolicy::size_type ThreadingPolicy::s_defaultMaxThreading = std::thread::hardware_concurrency();
ThreadingPolicy::size_type ThreadingPolicy::s_defaultMaxMklThreading = MKL_Get_Max_Threads();


// Static members
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Public methods

ThreadingPolicy::size_type ThreadingPolicy::mklThreading()
{
	return static_cast<size_type>(MKL_Get_Max_Threads());
}

ThreadingPolicy::size_type ThreadingPolicy::mklDomainThreading(const std::string& domainName)
{
	return static_cast<size_type>(MKL_Domain_Get_Max_Threads(translateMklDomainName(domainName)));
}

ThreadingPolicy::size_type ThreadingPolicy::mklStriping()
{
	return static_cast<std::size_t>(MKL_Get_Num_Stripes());
}

bool ThreadingPolicy::isMklDynamic()
{
	if (0 == MKL_Get_Dynamic())
		return false;
	else
		return true;
}

void ThreadingPolicy::setMklThreading(const size_type mklThreading)
{
	if (mklThreading == 0)
		MKL_Set_Num_Threads(static_cast<int>(s_maxThreading));
	else
		MKL_Set_Num_Threads(static_cast<int>(mklThreading));
}

void ThreadingPolicy::setLocalMklThreading(const size_type localMklThreading)
{
	MKL_Set_Num_Threads_Local(static_cast<int>(localMklThreading));
}

void ThreadingPolicy::setMklDomainThreading(const std::string& domainName, const size_type mklDomainThreading)
{
	if (MKL_Domain_Set_Num_Threads(static_cast<int>(mklDomainThreading), translateMklDomainName(domainName)) == 0)
		throw System::ExceptionServices::ArgumentOutOfRangeException{ "System::Parallel::ThreadingPolicy::setMklDomainThreading", "The function of \"MKL_Domain_Set_Num_Threads\" indicates a failure." };
}

void ThreadingPolicy::setMklStriping(const size_type mklStriping)
{
	MKL_Set_Num_Stripes(static_cast<int>(mklStriping));
}

void ThreadingPolicy::setMklDynamic(const bool requestDynamic)
{
	if (requestDynamic)
		MKL_Set_Dynamic(1);
	else
		MKL_Set_Dynamic(0);
}

// Public methods
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Private methods

int ThreadingPolicy::translateMklDomainName(const std::string& domainName)
{
	if (domainName == "ALL" || domainName == "All" || domainName == "all")
		return MKL_DOMAIN_ALL;

	else
	{
		if (domainName == "BLAS" || domainName == "CBLAS")
			return MKL_DOMAIN_BLAS;

		else
		{
			if (domainName == "FFT")
				return MKL_DOMAIN_FFT;

			else
			{
				if (domainName == "VML")
					return MKL_DOMAIN_VML;

				else
				{
					if (domainName == "LAPACK" || domainName == "LAPACKE")
						return MKL_DOMAIN_LAPACK;

					else
						throw System::ExceptionServices::ArgumentOutOfRangeException{ "System::Parallel::ThreadingPolicy::translateMklDomainName", "\"domainName\" is nonsense." };
				}
			}
		}
	}
}

// Private methods
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
