#include "OptimalAtom.h"

#include <algorithm>

#include "StreamWriter.h"
#include "InvalidFileException.h"

#include "ConstrainingAtom.h"
#include "SphericalAtom.h"

using namespace MathematicalCrystalChemistry::CrystalModel::Components;


// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Constructors

OptimalAtom::OptimalAtom() noexcept
	: CrystallographicAtom{}
	, _coordinations{}
	, _vertexSharings{}
	, _edgeSharings{}
	, _faceSharings{}
{
}

OptimalAtom::OptimalAtom(const IonicAtomicNumber& number) noexcept
	: CrystallographicAtom{ number }
	, _coordinations{}
	, _vertexSharings{}
	, _edgeSharings{}
	, _faceSharings{}
{
}

OptimalAtom::OptimalAtom(const IonicAtomicNumber& number, const NumericalVector& coordinate) noexcept
	: CrystallographicAtom{ number, coordinate }
	, _coordinations{}
	, _vertexSharings{}
	, _edgeSharings{}
	, _faceSharings{}
{
}

OptimalAtom::OptimalAtom(const ConstrainingAtom& atom) noexcept
	: CrystallographicAtom{ atom.ionicAtomicNumber(), atom.cartesianCoordinate()}
	, _coordinations{}
	, _vertexSharings{}
	, _edgeSharings{}
	, _faceSharings{}
{
}

// Constructors
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Property

void OptimalAtom::addCoordination(const IonicAtomicNumber& argumentNumber) noexcept
{
	_coordinations.push_back(argumentNumber);
	std::sort(_coordinations.begin(), _coordinations.end());
}

void OptimalAtom::addVertexSharings(const std::pair<IonicAtomicNumber, IonicAtomicNumber>& sharing) noexcept
{
	_vertexSharings.push_back(sharing);
	std::sort(_vertexSharings.begin(), _vertexSharings.end());
}

void OptimalAtom::addEdgeSharings(const std::pair<IonicAtomicNumber, std::array<IonicAtomicNumber, 2>>& sharing) noexcept
{
	_edgeSharings.push_back(sharing);
	std::sort(_edgeSharings.begin(), _edgeSharings.end());
}

void OptimalAtom::addFaceSharings(const std::pair<IonicAtomicNumber, std::vector<IonicAtomicNumber>>& sharing) noexcept
{
	_faceSharings.push_back(sharing);
	std::sort(_faceSharings.begin(), _faceSharings.end());
}

// Property
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Methods

std::string OptimalAtom::getAbridgedFingerprint() const
{
	System::IO::StreamWriter streamWriter;
	{
		streamWriter.write("\tCoordination.Number\t\t");
		streamWriter.writeLine(_coordinations.size());

		streamWriter.write("\tNumber.of.Vertex.Sharings\t");
		streamWriter.writeLine(_vertexSharings.size());

		streamWriter.write("\tNumber.of.Edge.Sharings\t\t");
		streamWriter.writeLine(_edgeSharings.size());

		streamWriter.write("\tNumber.of.Face.Sharings\t\t");
		streamWriter.writeLine(_faceSharings.size());
	}

	return streamWriter.allTexts();
}

std::string OptimalAtom::getFingerprint() const
{
	System::IO::StreamWriter streamWriter;
	{
		if (siteSymmetrySymbol().isValid())
		{
			streamWriter.write("\tSite.Symmetry.Symbol\t\t");
			streamWriter.writeLine(siteSymmetrySymbol());

			streamWriter.write("\tCoordination.Number\t\t");
			streamWriter.writeLine(_coordinations.size());

			streamWriter.write("\tNumber.of.Vertex.Sharings\t");
			streamWriter.writeLine(_vertexSharings.size());

			streamWriter.write("\tNumber.of.Edge.Sharings\t\t");
			streamWriter.writeLine(_edgeSharings.size());

			streamWriter.write("\tNumber.of.Face.Sharings\t\t");
			streamWriter.writeLine(_faceSharings.size());
		}

		else
			throw System::ExceptionServices::InvalidOperationException{ typeid(*this), "getFingerprint", "Site symmetry symbol is empty." };
	}

	return streamWriter.allTexts();
}

std::string OptimalAtom::getDetailedFingerprint() const
{
	System::IO::StreamWriter streamWriter;
	{
		if (siteSymmetrySymbol().isValid())
		{
			streamWriter.write("\tSite.Symmetry.Symbol\t\t");
			streamWriter.writeLine(siteSymmetrySymbol());

			writeCoordinations(streamWriter);
			writeVertexSharings(streamWriter);
			writeEdgeSharings(streamWriter);
			writeFaceSharings(streamWriter);
		}

		else
			throw System::ExceptionServices::InvalidOperationException{ typeid(*this), "getDetailedFingerprint", "Site symmetry symbol is empty." };
	}

	return streamWriter.allTexts();
}

// Methods
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Private methods

void OptimalAtom::writeCoordinations(System::IO::StreamWriter& streamWriter) const
{
	streamWriter.write("\tCoordinations\t\t");
	{
		for (const auto& coordination : _coordinations)
		{
			streamWriter.write(coordination.toString());
			streamWriter.write(", ");
		}

		streamWriter.popBack();
		streamWriter.popBack();
	}

	streamWriter.breakLine();
}

void OptimalAtom::writeVertexSharings(System::IO::StreamWriter& streamWriter) const
{
	streamWriter.write("\tVertex.Sharings\t\t");
	{
		for (const auto& vertexSharing : _vertexSharings)
		{
			streamWriter.write("=<");
			streamWriter.write(vertexSharing.second.toString());
			streamWriter.write(">=");
			streamWriter.write(vertexSharing.first.toString());
			streamWriter.write(", ");
		}

		streamWriter.popBack();
		streamWriter.popBack();
	}

	streamWriter.breakLine();
}

void OptimalAtom::writeEdgeSharings(System::IO::StreamWriter& streamWriter) const
{
	streamWriter.write("\tEdge.Sharings\t\t");
	{
		for (const auto& edgeSharing : _edgeSharings)
		{
			streamWriter.write("=<");
			{
				for (const auto& bridging : edgeSharing.second)
				{
					streamWriter.write(bridging.toString());
					streamWriter.write("_");
				}

				streamWriter.popBack();
			}
			streamWriter.write(">=");
			streamWriter.write(edgeSharing.first.toString());
			streamWriter.write(", ");
		}

		streamWriter.popBack();
		streamWriter.popBack();
	}

	streamWriter.breakLine();
}

void OptimalAtom::writeFaceSharings(System::IO::StreamWriter& streamWriter) const
{
	streamWriter.write("\tFace.Sharings\t\t");
	{
		for (const auto& faceSharing : _faceSharings)
		{
			streamWriter.write("=<");
			{
				for (const auto& bridging : faceSharing.second)
				{
					streamWriter.write(bridging.toString());
					streamWriter.write("_");
				}

				streamWriter.popBack();
			}
			streamWriter.write(">=");
			streamWriter.write(faceSharing.first.toString());
			streamWriter.write(", ");
		}

		streamWriter.popBack();
		streamWriter.popBack();
	}

	streamWriter.breakLine();
}

// Private methods
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
