#include "CrystalOptimizer.h"

#include <cmath>

using namespace MathematicalCrystalChemistry::Design::Optimization;


// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Constructors

CrystalOptimizer::CrystalOptimizer() noexcept
	: _structuralOptimizationParameters{}
	, _exclusiveRadiusRatio{ 1.0 }
	, m_inverseBasisVectors{ MathToolkit::LinearAlgebra::getIdentityMatrix<double, 3>() }
	, m_unitCellTransformation{}
{
}

CrystalOptimizer::CrystalOptimizer(const StructuralOptimizationParameters& structural, const GeometricalConstraintParameters& geometrical)
	: _structuralOptimizationParameters{ structural }
	, _exclusiveRadiusRatio{ geometrical.minimumExclusionDistanceRatio() }
	, m_inverseBasisVectors{ MathToolkit::LinearAlgebra::getIdentityMatrix<double, 3>() }
	, m_unitCellTransformation{}
{
}

// Constructors
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Methods

void CrystalOptimizer::execute(ObjectiveCrystalStructure& structure) const
{
	m_unitCellTransformation = 0.0;
	double maxAtomicDisplacement = _structuralOptimizationParameters.initialMaxAtomicDisplacement();
	double maxUnitCellDisplacement = _structuralOptimizationParameters.initialMaxUnitCellDisplacement();


	for (size_type structuralOptimizing = 0; structuralOptimizing < _structuralOptimizationParameters.maxStructuralOptimizing(); ++structuralOptimizing)
	{
		m_inverseBasisVectors = structure.unitCell().getInverseBasisVectors();
		applyForces(structure);
		applyPressure(structure);


		for (auto& atom : structure.atoms())
			atom.move(maxAtomicDisplacement);


		double unitCellTransformationNormSquare = m_unitCellTransformation.getHilbertSchmidtNormSquare();
		{
			if ((maxUnitCellDisplacement * maxUnitCellDisplacement) < unitCellTransformationNormSquare)
				m_unitCellTransformation *= (maxUnitCellDisplacement / std::sqrt(unitCellTransformationNormSquare));

			structure.unitCell().basisVectors() += m_unitCellTransformation;
			m_unitCellTransformation = 0.0;
		}


		maxAtomicDisplacement *= _structuralOptimizationParameters.displacementDecreasingFactor();
		maxUnitCellDisplacement *= _structuralOptimizationParameters.displacementDecreasingFactor();
	}
}

void CrystalOptimizer::execute(ObjectiveCrystalStructure& structure, CrystalDesignRecorder& recorder) const
{
	m_unitCellTransformation = 0.0;
	double maxAtomicDisplacement = _structuralOptimizationParameters.initialMaxAtomicDisplacement();
	double maxUnitCellDisplacement = _structuralOptimizationParameters.initialMaxUnitCellDisplacement();


	for (size_type structuralOptimizing = 0; structuralOptimizing < _structuralOptimizationParameters.maxStructuralOptimizing(); ++structuralOptimizing)
	{
		m_inverseBasisVectors = structure.unitCell().getInverseBasisVectors();
		applyForces(structure);
		applyPressure(structure);


		for (auto& atom : structure.atoms())
			atom.move(maxAtomicDisplacement);


		double unitCellTransformationNormSquare = m_unitCellTransformation.getHilbertSchmidtNormSquare();
		{
			if ((maxUnitCellDisplacement * maxUnitCellDisplacement) < unitCellTransformationNormSquare)
				m_unitCellTransformation *= (maxUnitCellDisplacement / std::sqrt(unitCellTransformationNormSquare));

			structure.unitCell().basisVectors() += m_unitCellTransformation;
			m_unitCellTransformation = 0.0;
		}


		/*
		for (auto& atom : structure.atoms())
		{
			NumericalVector coordinate = structure.unitCell().basisVectors() * (m_inverseBasisVectors * atom.cartesianCoordinate());
			atom.cartesianCoordinate() = coordinate;
		}
		*/

		maxAtomicDisplacement *= _structuralOptimizationParameters.displacementDecreasingFactor();
		maxUnitCellDisplacement *= _structuralOptimizationParameters.displacementDecreasingFactor();

		recorder.record(structure);
	}
}

// Methods
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Private methods

void CrystalOptimizer::applyForces(ObjectiveCrystalStructure& structure) const noexcept
{
	for (const auto& indices : structure.covalentBondedIndices())
		applyCovalentBondingForce(indices, structure);

	for (const auto& indices : structure.covalentExcludedIndices())
		applyCovalentExcludingForce(indices, structure);

	for (const auto& indices : structure.ionicBondedIndices())
		applyIonicBondingForce(indices, structure);

	for (const auto& indices : structure.ionicExcludedIndices())
		applyIonicExcludingForce(indices, structure);

	for (const auto& indices : structure.ionicRepulsedIndices())
		applyIonicRepulsingForce(indices, structure);

	for (const auto& indices : structure.translatedCovalentBondedIndices())
		applyCovalentBondingForce(indices, structure);

	for (const auto& indices : structure.translatedCovalentExcludedIndices())
		applyCovalentExcludingForce(indices, structure);

	for (const auto& indices : structure.translatedIonicBondedIndices())
		applyIonicBondingForce(indices, structure);

	for (const auto& indices : structure.translatedIonicExcludedIndices())
		applyIonicExcludingForce(indices, structure);

	for (const auto& indices : structure.translatedIonicRepulsedIndices())
		applyIonicRepulsingForce(indices, structure);
}

// Private methods
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
