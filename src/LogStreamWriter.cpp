#include "LogStreamWriter.h"

#include "Directory.h"
#include "DirectoryNotFoundException.h"
#include "File.h"

#include "DateTime.h"

using namespace System::IO;


// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Methods

std::mutex LogStreamWriter::s_logMutex;


LogStreamWriter::LogStreamWriter() noexcept
	: FileStream{}
{
}

LogStreamWriter::LogStreamWriter(const std::filesystem::path& directoryPath)
	: FileStream{}
{
	if (Directory::exist(directoryPath))
	{
		std::filesystem::path logFilePath = directoryPath;
		logFilePath /= getLogFilename();


		std::lock_guard<std::mutex> guard{ s_logMutex };

		if (File::exist(logFilePath))
			setExistingFilePath(logFilePath, FileMode::append);

		else
		{
			set(logFilePath, FileMode::createNew);
			FileStream::write(writeHeaderMessage());
		}
	}

	else
	{
		std::string message;
		{
			message += "Could not find the directory of \"";
			message += directoryPath.generic_string();
			message += "\".";
		}

		throw DirectoryNotFoundException{ typeid(*this), "constructor", message };
	}
}

// Constructors
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Methods

void LogStreamWriter::setDirectoryPath(const std::filesystem::path& directoryPath)
{
	if (Directory::exist(directoryPath))
	{
		std::filesystem::path logFilePath = directoryPath;
		logFilePath /= getLogFilename();
		

		std::lock_guard<std::mutex> guard{ s_logMutex };

		if (File::exist(logFilePath))
			setExistingFilePath(logFilePath, FileMode::append);

		else
		{
			set(logFilePath, FileMode::createNew);
			FileStream::write(writeHeaderMessage());
		}
	}

	else
	{
		std::string message;
		{
			message += "Could not find the directory of \"";
			message += directoryPath.generic_string();
			message += "\".";
		}

		throw DirectoryNotFoundException{ typeid(*this), "constructor", message };
	}
}

void LogStreamWriter::eraseLogFile(const std::filesystem::path& directoryPath)
{
	if (Directory::exist(directoryPath))
	{
		std::filesystem::path logFilePath = directoryPath;
		logFilePath /= getLogFilename();


		std::lock_guard<std::mutex> guard{ s_logMutex };
		System::IO::File::deleteFile(logFilePath);
	}
}

// Methods
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Private methods

std::string LogStreamWriter::writeHeaderMessage() noexcept
{
	std::string headerMessage;
	{
		headerMessage += "----------------------------------------------------------------------------------------------------\n\n";
		headerMessage += System::Utility::DateTime::toTimeString(System::Utility::DateTime::getNowTime());
		headerMessage += "\n\tLog file is created.\n\n";
		headerMessage += "----------------------------------------------------------------------------------------------------\n\n";
	}

	return headerMessage;
}

// Private methods
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
