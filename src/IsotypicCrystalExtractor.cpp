#include "IsotypicCrystalExtractor.h"

#include "InvalidOperationException.h"

#include "Directory.h"
#include "File.h"
#include "FileStream.h"

#include "CifStreamReader.h"

using namespace MathematicalCrystalChemistry::Analysis;


// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Constructors

IsotypicCrystalExtractor::IsotypicCrystalExtractor() noexcept
	: _crystalIdentificationParameters{}
{
}

IsotypicCrystalExtractor::IsotypicCrystalExtractor(const IsotypicCrystalExtractionParameters& parameters) noexcept
	: _crystalIdentificationParameters{ parameters }
{
}

// Constructors
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Methods

bool IsotypicCrystalExtractor::isRegisteredCrystal(const OptimalCrystalStructure& optimalCrystalStructure) const
{
	if (System::IO::Directory::exist(_crystalIdentificationParameters.databaseDirectoryPath()))
	{
		for (const auto& cifFilePath : System::IO::Directory::enumerateFiles(_crystalIdentificationParameters.databaseDirectoryPath(), std::string{ "([\\-\\_[:alnum:]]+)[\\.]{1}cif" }, System::IO::Directory::SearchOptions::AllDirectories))
		{
			std::string cifFingerprint = readFingerprint(cifFilePath);

			if (optimalCrystalStructure.toStructuralFingerprint() == readFingerprint(cifFilePath))
				return true;
		}

		return false;
	}

	else
		throw System::ExceptionServices::InvalidOperationException{ typeid(*this), "isRegisteredCrystal", "Database directory path is not a path to a directory." };
}

// Methods
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Private methods

std::string IsotypicCrystalExtractor::readFingerprint(const std::filesystem::path& cifFilePath) const
{
	if (ChemToolkit::Crystallography::IO::CifStreamReader::isCorrectExtension(cifFilePath))
	{
		std::filesystem::path fingerprintFilePath = cifFilePath.parent_path();
		{
			fingerprintFilePath /= cifFilePath.stem().string();
			fingerprintFilePath += "_fingerprint.txt";
		}


		if (System::IO::File::exist(fingerprintFilePath))
		{
			System::IO::FileStream fingerprintStreamReader{ fingerprintFilePath, System::IO::FileStream::FileMode::openRead };
			return fingerprintStreamReader.readAllTexts();
		}

		else
		{
			std::string structureFingerprint;
			{
				OptimalCrystalStructure conventionalStructure;
				{
					ChemToolkit::Crystallography::IO::CifStreamReader cifStreamReader{ cifFilePath };
					conventionalStructure = OptimalCrystalStructure{ cifStreamReader.readCrystallographicStructure() };
				}

				conventionalStructure.conventionalizeStructure(_crystalIdentificationParameters.spaceGroupPrecision());
				structureFingerprint = conventionalStructure.toStructuralFingerprint();
			}


			System::IO::FileStream fingerprintStreamWriter{ fingerprintFilePath, System::IO::FileStream::FileMode::createNew };
			fingerprintStreamWriter.write(structureFingerprint);

			return structureFingerprint;
		}
	}

	else
		throw System::ExceptionServices::ArgumentOutOfRangeException{ typeid(*this), "readFingerprint", "Argument file path is not a path to a cif file." };
}

// Private methods
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
