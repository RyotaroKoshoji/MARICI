#ifndef MATHEMATICALCRYSTALCHEMISTRY_CRYSTALMODEL_CONSTRAINTS_INTERNAL_COORDINATIONPOLYHEDRACONNECTOR_H
#define MATHEMATICALCRYSTALCHEMISTRY_CRYSTALMODEL_CONSTRAINTS_INTERNAL_COORDINATIONPOLYHEDRACONNECTOR_H

#include <random>
#include <set>

#include "PolyhedralFeasibilityCheckerBase.h"


namespace MathematicalCrystalChemistry
{
	namespace CrystalModel
	{
		namespace Constraints
		{
			namespace Internal
			{
				class CoordinationPolyhedraConnector :public PolyhedralFeasibilityCheckerBase
				{
					struct KeyHasher
					{
						std::size_t operator()(const std::pair<IonicAtomicNumber, IonicAtomicNumber>&) const noexcept;
					};

					struct KeyEqual
					{
						bool operator()(const std::pair<IonicAtomicNumber, IonicAtomicNumber>&, const std::pair<IonicAtomicNumber, IonicAtomicNumber>&) const noexcept;
					};

					using FeasibleLinkingDictionary = std::unordered_map<std::pair<IonicAtomicNumber, IonicAtomicNumber>, std::vector<BasicChemicalComposition>, KeyHasher, KeyEqual>;


// **********************************************************************************************************************************************************************************************************************************************************************************************
				// Constructors, destructor, and operators

				public:
					CoordinationPolyhedraConnector() noexcept;
					virtual ~CoordinationPolyhedraConnector() = default;

					CoordinationPolyhedraConnector(const CoordinationPolyhedraConnector&) = default;
					CoordinationPolyhedraConnector(CoordinationPolyhedraConnector&&) noexcept = default;
					CoordinationPolyhedraConnector& operator=(const CoordinationPolyhedraConnector&) = default;
					CoordinationPolyhedraConnector& operator=(CoordinationPolyhedraConnector&&) noexcept = default;

				// Constructors, destructor, and operators
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
				// Property

					const CoordinationPolyhedraConnectionParameters& coordinationPolyhedraConnectionParameters() const noexcept;

					void setCoordinationPolyhedraConnectionParameters(const CoordinationPolyhedraConnectionParameters&) noexcept;

				// Property
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
				// Methods

					FeasibleLinkingDictionary getFeasibleLinkingDictionary(const ChemicalComposition& crystalComposition) const;
					FeasibleLinkingDictionary getFeasibleLinkingDictionary(const ConstrainingChemicalComposition& crystalComposition) const;

				// Methods
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
				// Private methods

				private:
					std::vector<BasicChemicalComposition> getFeasibleBridgingCompositions(const ConstrainingAtomicSpecies&, const ConstrainingAtomicSpecies&, const ConstrainingChemicalComposition& crystalComposition) const;

					std::pair<IonicAtomicNumber, IonicAtomicNumber> getIonicAtomicNumberKey(const IonicAtomicNumber&, const IonicAtomicNumber&) const;
					std::pair<IonicAtomicNumber, IonicAtomicNumber> getIonicAtomicNumberKey(const ConstrainingAtomicSpecies&, const ConstrainingAtomicSpecies&) const;

				// Private methods
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
				// Private utility

					std::set<BasicChemicalComposition> getPossibleBridgingCompositionDictionary(const std::set<BasicChemicalComposition>&, const std::set<BasicChemicalComposition>&) const;
					void initializeBridgingComposition(BasicChemicalComposition& bridgingComposition, const BasicChemicalComposition& maximumBridgingComposition) const;
					bool advanceBridgingComposition(BasicChemicalComposition& bridgingComposition, const BasicChemicalComposition& maximumBridgingComposition) const;

					void initializeConstrainingMolecularStructure(ConstrainingMolecularStructure&, const ConstrainingAtomicSpecies&, const ConstrainingAtomicSpecies&, const ConstrainingChemicalComposition& bridgingComposition) const;
					double getRepresentativeRadius(const ConstrainingAtom&) const;

				// Private utility
// **********************************************************************************************************************************************************************************************************************************************************************************************

				private:
					CoordinationPolyhedraConnectionParameters _coordinationPolyhedraConnectionParameters;

					mutable std::mt19937 m_randomEngine;
					mutable std::uniform_real_distribution<double> m_distributor;
				};



				inline std::size_t CoordinationPolyhedraConnector::KeyHasher::operator()(const std::pair<IonicAtomicNumber, IonicAtomicNumber>& ianp) const noexcept
				{
					return (ianp.first.getHashCode() ^ ianp.second.getHashCode());
				}

				inline bool CoordinationPolyhedraConnector::KeyEqual::operator()(const std::pair<IonicAtomicNumber, IonicAtomicNumber>& ianpa, const std::pair<IonicAtomicNumber, IonicAtomicNumber>& ianpb) const noexcept
				{
					return (ianpa == ianpb);
				}
			}
		}
	}
}

// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Property

inline const MathematicalCrystalChemistry::CrystalModel::Constraints::Internal::CoordinationPolyhedraConnectionParameters& MathematicalCrystalChemistry::CrystalModel::Constraints::Internal::CoordinationPolyhedraConnector::coordinationPolyhedraConnectionParameters() const noexcept
{
	return _coordinationPolyhedraConnectionParameters;
}

inline void MathematicalCrystalChemistry::CrystalModel::Constraints::Internal::CoordinationPolyhedraConnector::setCoordinationPolyhedraConnectionParameters(const CoordinationPolyhedraConnectionParameters& parameters) noexcept
{
	_coordinationPolyhedraConnectionParameters = parameters;
}

// Property
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Methods

inline MathematicalCrystalChemistry::CrystalModel::Constraints::Internal::CoordinationPolyhedraConnector::FeasibleLinkingDictionary MathematicalCrystalChemistry::CrystalModel::Constraints::Internal::CoordinationPolyhedraConnector::getFeasibleLinkingDictionary(const ChemicalComposition& crystalComposition) const
{
	return getFeasibleLinkingDictionary(toConstrainingChemicalComposition(crystalComposition));
}

// Methods
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Private methods


inline std::pair<MathematicalCrystalChemistry::CrystalModel::Constraints::Internal::CoordinationPolyhedraConnector::IonicAtomicNumber, MathematicalCrystalChemistry::CrystalModel::Constraints::Internal::CoordinationPolyhedraConnector::IonicAtomicNumber> MathematicalCrystalChemistry::CrystalModel::Constraints::Internal::CoordinationPolyhedraConnector::getIonicAtomicNumberKey(const IonicAtomicNumber& iana, const IonicAtomicNumber& ianb) const
{
	if (ianb < iana)
		return std::make_pair(ianb, iana);
	else
		return std::make_pair(iana, ianb);
}

inline std::pair<MathematicalCrystalChemistry::CrystalModel::Constraints::Internal::CoordinationPolyhedraConnector::IonicAtomicNumber, MathematicalCrystalChemistry::CrystalModel::Constraints::Internal::CoordinationPolyhedraConnector::IonicAtomicNumber> MathematicalCrystalChemistry::CrystalModel::Constraints::Internal::CoordinationPolyhedraConnector::getIonicAtomicNumberKey(const ConstrainingAtomicSpecies& casa, const ConstrainingAtomicSpecies& casb) const
{
	return getIonicAtomicNumberKey(casa.ionicAtomicNumber(), casb.ionicAtomicNumber());
}

// Private methods
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Private utility

inline void MathematicalCrystalChemistry::CrystalModel::Constraints::Internal::CoordinationPolyhedraConnector::initializeBridgingComposition(BasicChemicalComposition& bridgingComposition, const BasicChemicalComposition& maximumBridgingComposition) const
{
	bridgingComposition.clear();

	for (const auto& numAndCount : maximumBridgingComposition)
		bridgingComposition.add(numAndCount.first);
}

inline bool MathematicalCrystalChemistry::CrystalModel::Constraints::Internal::CoordinationPolyhedraConnector::advanceBridgingComposition(BasicChemicalComposition& bridgingComposition, const BasicChemicalComposition& maximumBridgingComposition) const
{
	for (auto& numAndCount : bridgingComposition)
	{
		if (numAndCount.second < maximumBridgingComposition.count(numAndCount.first))
		{
			numAndCount.second += 1;
			return true;
		}

		else
		{
			numAndCount.second = 1;
			continue;
		}
	}

	return false;
}

inline double MathematicalCrystalChemistry::CrystalModel::Constraints::Internal::CoordinationPolyhedraConnector::getRepresentativeRadius(const ConstrainingAtom& constrainingAtom) const
{
	if (constrainingAtom.ionicAtomicNumber().formalCharge().isAnion() || constrainingAtom.ionicAtomicNumber().formalCharge().isCation())
		return constrainingAtom.ionicRadius().minimum();
	else
		return constrainingAtom.covalentRadius().minimum();
}

// Private utility
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************


#endif // !MATHEMATICALCRYSTALCHEMISTRY_CRYSTALMODEL_CONSTRAINTS_INTERNAL_COORDINATIONPOLYHEDRACONNECTOR_H
