#ifndef MATHEMATICALCRYSTALCHEMISTRY_CRYSTALMODEL_COMPONENTS_CONSTRAININGCRYSTALSTRUCTURE_H
#define MATHEMATICALCRYSTALCHEMISTRY_CRYSTALMODEL_COMPONENTS_CONSTRAININGCRYSTALSTRUCTURE_H

#include <cmath>
#include <utility>
#include <random>

#include "LinkedPolyhedraRetriever.h"


namespace MathematicalCrystalChemistry
{
	namespace CrystalModel
	{
		namespace Components
		{
			class ObjectiveCrystalStructure;
			class OptimalCrystalStructure;


			class ConstrainingCrystalStructure :public Internal::LinkedPolyhedraRetriever
			{
// **********************************************************************************************************************************************************************************************************************************************************************************************
			// Constructors, destructor, and operators

			public:
				ConstrainingCrystalStructure() noexcept;
				ConstrainingCrystalStructure(const ChemToolkit::Crystallography::UnitCell&, const std::vector<ConstrainingAtom>&) noexcept;
				ConstrainingCrystalStructure(const ChemToolkit::Crystallography::UnitCell&, std::vector<ConstrainingAtom>&&) noexcept;
				explicit ConstrainingCrystalStructure(const ObjectiveCrystalStructure&);
				explicit ConstrainingCrystalStructure(const OptimalCrystalStructure&);

				virtual ~ConstrainingCrystalStructure() = default;

				ConstrainingCrystalStructure(const ConstrainingCrystalStructure&) = default;
				ConstrainingCrystalStructure(ConstrainingCrystalStructure&&) noexcept = default;
				ConstrainingCrystalStructure& operator=(const ConstrainingCrystalStructure&) = default;
				ConstrainingCrystalStructure& operator=(ConstrainingCrystalStructure&&) noexcept = default;

			// Constructors, destructor, and operators
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
			// Property

				double minimumFeasiblePackingFraction() const noexcept;

				void setMinimumFeasiblePackingFraction(const double);

			// Property
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
			// Methods

				void initialize() noexcept override;
				void initialize(const ChemToolkit::Crystallography::UnitCell&) noexcept override;
				void initialize(const ChemToolkit::Crystallography::UnitCell&, const std::vector<ConstrainingAtom>&) noexcept override;
				void initialize(const ChemToolkit::Crystallography::UnitCell&, std::vector<ConstrainingAtom>&&) noexcept override;

				void importStructure(const ObjectiveCrystalStructure&);
				void import(const ObjectiveCrystalStructure&);
				void import(const OptimalCrystalStructure&);

				void distortStructure();
				void distortStructureLargely();
				void reduceStructure();

				void createInteratomicDistanceConstraints();
				void eraseInfeasibleIonicPolyhedraConnections();

				bool isFeasible() const;
				bool isFeasibleCoordinationComposition() const;

				bool hasFeasibleUnitCell() const;
				double getPackingFraction() const;

			// Methods
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
			// Private methods

			private:
				void createChemicalBonds();
				void optimizeCoordinationCompositions();

				double getAtomicSphereVolume() const;

			// Private methods
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
			// Private utility

				void makeClosestCoordinationComposition(const OriginalAtomIndex);
				void makeClosestCoordinationNumber(const OriginalAtomIndex, const size_type closestCoordinationNumber, std::vector<std::pair<double, OriginalAtomIndex>>&, std::vector<std::pair<double, TranslatedAtomIndex>>&);
				void makeClosestCoordinationNumber(const OriginalAtomIndex, const size_type closestCoordinationNumber, const ChemicalComposition& closestLowerBoundComposition, std::vector<std::pair<double, OriginalAtomIndex>>&, std::vector<std::pair<double, TranslatedAtomIndex>>&);

				bool willChooseOriginalAtomIndex(const ConstrainerIndices<TranslatedAtomIndex>&) const;

			// Private utility
// **********************************************************************************************************************************************************************************************************************************************************************************************

			private:
				double _minimumFeasiblePackingFraction;

				mutable std::mt19937 m_randomEngine;

				static double s_defaultMinimumFeasiblePackingFraction;
			};
		}
	}
}

// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Property

inline double MathematicalCrystalChemistry::CrystalModel::Components::ConstrainingCrystalStructure::minimumFeasiblePackingFraction() const noexcept
{
	return _minimumFeasiblePackingFraction;
}

inline void MathematicalCrystalChemistry::CrystalModel::Components::ConstrainingCrystalStructure::setMinimumFeasiblePackingFraction(const double val)
{
	if (val < 0.0)
		throw System::ExceptionServices::ArgumentOutOfRangeException{ typeid(*this), "setMinimumFeasiblePackingFraction", "Argument value is less than zero." };
	else
		_minimumFeasiblePackingFraction = val;
}

// Property
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Methods

inline void MathematicalCrystalChemistry::CrystalModel::Components::ConstrainingCrystalStructure::initialize() noexcept
{
	CrystalStructure::initialize();
}

inline void MathematicalCrystalChemistry::CrystalModel::Components::ConstrainingCrystalStructure::initialize(const ChemToolkit::Crystallography::UnitCell& uc) noexcept
{
	CrystalStructure::initialize(uc);
	CrystallineConstraintManager::clearInteratomicDistanceConstraints();
}

inline void MathematicalCrystalChemistry::CrystalModel::Components::ConstrainingCrystalStructure::initialize(const ChemToolkit::Crystallography::UnitCell& uc, const std::vector<ConstrainingAtom>& atoms) noexcept
{
	CrystalStructure::initialize(uc, atoms);
	CrystallineConstraintManager::clearInteratomicDistanceConstraints();
}

inline void MathematicalCrystalChemistry::CrystalModel::Components::ConstrainingCrystalStructure::initialize(const ChemToolkit::Crystallography::UnitCell& uc, std::vector<ConstrainingAtom>&& atoms) noexcept
{
	CrystalStructure::initialize(uc, std::move(atoms));
	CrystallineConstraintManager::clearInteratomicDistanceConstraints();
}

inline void MathematicalCrystalChemistry::CrystalModel::Components::ConstrainingCrystalStructure::createInteratomicDistanceConstraints()
{
	clearCovalentBonds();
	clearIonicBonds();
	clearIonicRepulsions();

	CrystallineConstraintManager::updateConstrainingIndexPairs();
	createChemicalBonds();
	optimizeCoordinationCompositions();
}

inline bool MathematicalCrystalChemistry::CrystalModel::Components::ConstrainingCrystalStructure::isFeasibleCoordinationComposition() const
{
	for (size_type index = 0; index < atoms().size(); ++index)
	{
		if (!(hasFeasibleCoordinationComposition(index)))
			return false;
	}

	return true;
}

inline bool MathematicalCrystalChemistry::CrystalModel::Components::ConstrainingCrystalStructure::hasFeasibleUnitCell() const
{
	double cellVolume = unitCell().getCellVolume();


	if ((0.0 < cellVolume) && ((_minimumFeasiblePackingFraction * cellVolume) < getAtomicSphereVolume()))
	{
		ChemToolkit::Crystallography::UnitCell::LatticeParameters latticeParameters = unitCell().getLatticeParameters();
		{
			if (latticeParameters.angles.alpha < (0.2 * MathToolkit::Generic::MathConstants::getPi()))
				return false;
			if ((0.8 * MathToolkit::Generic::MathConstants::getPi()) < latticeParameters.angles.alpha)
				return false;

			if (latticeParameters.angles.beta < (0.2 * MathToolkit::Generic::MathConstants::getPi()))
				return false;
			if ((0.8 * MathToolkit::Generic::MathConstants::getPi()) < latticeParameters.angles.beta)
				return false;

			if (latticeParameters.angles.gamma < (0.2 * MathToolkit::Generic::MathConstants::getPi()))
				return false;
			if ((0.8 * MathToolkit::Generic::MathConstants::getPi()) < latticeParameters.angles.gamma)
				return false;
		}

		return true;
	}

	else
		return false;
}

inline double MathematicalCrystalChemistry::CrystalModel::Components::ConstrainingCrystalStructure::getPackingFraction() const
{
	return (getAtomicSphereVolume() / unitCell().getCellVolume());
}

// Methods
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Private methods

inline double MathematicalCrystalChemistry::CrystalModel::Components::ConstrainingCrystalStructure::getAtomicSphereVolume() const
{
	double atomicVolume = 0.0;
	{
		for (const auto& atom : atoms())
		{
			if (atom.ionicAtomicNumber().formalCharge().isAnion() || atom.ionicAtomicNumber().formalCharge().isCation())
				atomicVolume += 1.33333333333333 * MathToolkit::Generic::MathConstants::getPi() * atom.ionicRadius().minimum() * atom.ionicRadius().minimum() * atom.ionicRadius().minimum();
			else
				atomicVolume += 1.33333333333333 * MathToolkit::Generic::MathConstants::getPi() * atom.covalentRadius().minimum() * atom.covalentRadius().minimum() * atom.covalentRadius().minimum();
		}
	}

	return atomicVolume;
}

// Private methods
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Private utility

inline bool MathematicalCrystalChemistry::CrystalModel::Components::ConstrainingCrystalStructure::willChooseOriginalAtomIndex(const ConstrainerIndices<TranslatedAtomIndex>& constrainerIndices) const
{
	std::uniform_int_distribution<int> selector{ 0,1 };

	if (selector(m_randomEngine) == 0)
		return true;
	else
		return false;
}

// Private utility
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************


#endif // !MATHEMATICALCRYSTALCHEMISTRY_CRYSTALMODEL_COMPONENTS_CONSTRAININGCRYSTALSTRUCTURE_H
