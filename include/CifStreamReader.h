#ifndef CHEMTOOLKIT_CRYSTALLOGRAPHY_IO_CIFSTREAMREADER_H
#define CHEMTOOLKIT_CRYSTALLOGRAPHY_IO_CIFSTREAMREADER_H

#include <vector>

#include "FileStream.h"
#include "StreamReader.h"

#include "AtomicNumber.h"
#include "CrystallographicSymmetryOperation.h"
#include "SpaceGroupNumber.h"

#include "UnitCell.h"
#include "CrystallographicAtom.h"
#include "CrystallographicStructure.h"
#include "CrystallographicInformation.h"


namespace ChemToolkit
{
	namespace Crystallography
	{
		namespace IO
		{
			class CifStreamReader :private System::IO::FileStream
			{
				using NumericalVector = MathToolkit::LinearAlgebra::NumericalVector<double, 3>;
				using NumericalMatrix = MathToolkit::LinearAlgebra::NumericalMatrix<double, 3, 3>;

				using AtomicNumber = ChemToolkit::Generic::AtomicNumber;
				using SymmetryOperation = ChemToolkit::Crystallography::Symmetry::CrystallographicSymmetryOperation;
				using SpaceGroupNumber = ChemToolkit::Crystallography::Symmetry::SpaceGroupNumber;

// **********************************************************************************************************************************************************************************************************************************************************************************************
			// Constructors, destructor, and operators

			public:
				CifStreamReader() = default;
				explicit CifStreamReader(const std::filesystem::path&);

				virtual ~CifStreamReader() = default;

				CifStreamReader(const CifStreamReader&) = default;
				CifStreamReader(CifStreamReader&&) noexcept = default;
				CifStreamReader& operator=(const CifStreamReader&) = default;
				CifStreamReader& operator=(CifStreamReader&&) noexcept = default;

			// Constructors, destructor, and operators
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
			// Static methods

				static std::string correctExtension() noexcept;
				static bool isCorrectExtension(const std::filesystem::path filePath) noexcept;

			// Static methods
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
			// Methods

				CrystallographicStructure<CrystallographicAtom> readCrystallographicStructure() const;
				CrystallographicInformation readCrystallographicInformation() const;

			// Methods
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
			// Private methods

			private:
				UnitCell readUnitCell(const System::IO::StreamReader& streamReader) const;
				std::vector<AtomSite> readAtomSites(const std::string& inputText) const;

				std::vector<SymmetryOperation> readSymmetryOperations(const std::string& inputText) const;
				SpaceGroupNumber readSpaceGroupNumber(const System::IO::StreamReader& streamReader) const;

			// Private methods
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
			// Private utility

				int toFormalCharge(const std::string&) const;

				std::string getLoopText(const std::string& inputText, const std::string& dataSign) const;
				std::vector<std::string> readLoopDataNames(const std::string& inputText, const std::string& dataSign) const;

			// Private utility
// **********************************************************************************************************************************************************************************************************************************************************************************************
			};
		}
	}
}

// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Static methods

inline std::string ChemToolkit::Crystallography::IO::CifStreamReader::correctExtension() noexcept
{
	return std::string{ ".cif" };
}

inline bool ChemToolkit::Crystallography::IO::CifStreamReader::isCorrectExtension(const std::filesystem::path filePath) noexcept
{
	if (filePath.extension().string() == correctExtension())
		return true;
	else
		return false;
}

// Static methods
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Methods

inline ChemToolkit::Crystallography::CrystallographicStructure<ChemToolkit::Crystallography::CrystallographicAtom> ChemToolkit::Crystallography::IO::CifStreamReader::readCrystallographicStructure() const
{
	return readCrystallographicInformation().toCrystallographicStructure();
}

inline ChemToolkit::Crystallography::CrystallographicInformation ChemToolkit::Crystallography::IO::CifStreamReader::readCrystallographicInformation() const
{
	CrystallographicInformation crystallographicInformation;
	{
		std::string inputAllTexts = readAllTexts();
		crystallographicInformation.setAtomSites(readAtomSites(inputAllTexts));
		crystallographicInformation.setSymmetryOperations(readSymmetryOperations(inputAllTexts));

		System::IO::StreamReader streamReader{ std::move(inputAllTexts) };
		crystallographicInformation.setUnitCell(readUnitCell(streamReader));
		crystallographicInformation.setSpaceGroupNumber(readSpaceGroupNumber(streamReader));
	}

	return crystallographicInformation;
}

// Methods
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************

#endif // !CHEMTOOLKIT_CRYSTALLOGRAPHY_IO_CIFSTREAMREADER_H
