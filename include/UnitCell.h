#ifndef CHEMTOOLKIT_CRYSTALLOGRAPHY_UNITCELL_H
#define CHEMTOOLKIT_CRYSTALLOGRAPHY_UNITCELL_H

#include <cmath>

#include "ArgumentOutOfRangeException.h"

#include "NumericalMatrix.h"
#include "MathConstants.h"


namespace ChemToolkit
{
	namespace Crystallography
	{
		class DynamicUnitCell;


		class UnitCell
		{
			using size_type = std::size_t;
			using NumericalVector = MathToolkit::LinearAlgebra::NumericalVector<double, 3>;
			using NumericalMatrix = MathToolkit::LinearAlgebra::NumericalMatrix<double, 3, 3>;

		public:
			struct LatticeParameters final
			{
				struct Lengths
				{
					double a;
					double b;
					double c;
				};

				struct Angles
				{
					double alpha;
					double beta;
					double gamma;
				};

				Lengths lengths;
				Angles angles;
			};

// **********************************************************************************************************************************************************************************************************************************************************************************************
		// Constructors, destructor, and operators

		public:
			UnitCell() noexcept;
			explicit UnitCell(const NumericalMatrix& basisVectors) noexcept;
			explicit UnitCell(NumericalMatrix&& basisVectors) noexcept;
			explicit UnitCell(const LatticeParameters&);

			virtual ~UnitCell() = default;

			UnitCell(const UnitCell&) = default;
			UnitCell(UnitCell&&) noexcept = default;
			UnitCell& operator=(const UnitCell&) = default;
			UnitCell& operator=(UnitCell&&) noexcept = default;

		// Constructors, destructor, and operators
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
		// Property

			const NumericalMatrix& basisVectors() const noexcept;
			NumericalMatrix& basisVectors() noexcept;


		// Property
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
		// Methods

			NumericalMatrix getInverseBasisVectors() const noexcept;
			NumericalMatrix getReciprocalVectors() const noexcept;

			bool hasPositiveVolume() const noexcept;
			double getCellVolume() const noexcept;
			LatticeParameters getLatticeParameters() const;

			void clear() noexcept;

		// Methods
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
		// Private methods

		private:
			double getAngle(const NumericalVector&, const NumericalVector&) const noexcept;

		// Static methods
// **********************************************************************************************************************************************************************************************************************************************************************************************

		private:
			NumericalMatrix _basisVectors;
		};
	}
}

// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Property

inline const ChemToolkit::Crystallography::UnitCell::NumericalMatrix& ChemToolkit::Crystallography::UnitCell::basisVectors() const noexcept
{
	return _basisVectors;
}

inline ChemToolkit::Crystallography::UnitCell::NumericalMatrix& ChemToolkit::Crystallography::UnitCell::basisVectors() noexcept
{
	return _basisVectors;
}

// Property
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Methods

inline ChemToolkit::Crystallography::UnitCell::NumericalMatrix ChemToolkit::Crystallography::UnitCell::getInverseBasisVectors() const noexcept
{
	NumericalMatrix inverseMatrix;
	{
		inverseMatrix(0, 0) = (_basisVectors(1, 1) * _basisVectors(2, 2)) - (_basisVectors(2, 1) * _basisVectors(1, 2));
		inverseMatrix(0, 1) = (_basisVectors(2, 1) * _basisVectors(0, 2)) - (_basisVectors(0, 1) * _basisVectors(2, 2));
		inverseMatrix(0, 2) = (_basisVectors(0, 1) * _basisVectors(1, 2)) - (_basisVectors(1, 1) * _basisVectors(0, 2));

		inverseMatrix(1, 0) = (_basisVectors(1, 2) * _basisVectors(2, 0)) - (_basisVectors(2, 2) * _basisVectors(1, 0));
		inverseMatrix(1, 1) = (_basisVectors(2, 2) * _basisVectors(0, 0)) - (_basisVectors(0, 2) * _basisVectors(2, 0));
		inverseMatrix(1, 2) = (_basisVectors(0, 2) * _basisVectors(1, 0)) - (_basisVectors(1, 2) * _basisVectors(0, 0));

		inverseMatrix(2, 0) = (_basisVectors(1, 0) * _basisVectors(2, 1)) - (_basisVectors(2, 0) * _basisVectors(1, 1));
		inverseMatrix(2, 1) = (_basisVectors(2, 0) * _basisVectors(0, 1)) - (_basisVectors(0, 0) * _basisVectors(2, 1));
		inverseMatrix(2, 2) = (_basisVectors(0, 0) * _basisVectors(1, 1)) - (_basisVectors(1, 0) * _basisVectors(0, 1));
	}

	double primitiveCellVolume = 0.0;
	{
		primitiveCellVolume += _basisVectors(0, 0) * inverseMatrix(0, 0);
		primitiveCellVolume += _basisVectors(1, 0) * inverseMatrix(0, 1);
		primitiveCellVolume += _basisVectors(2, 0) * inverseMatrix(0, 2);
	}

	inverseMatrix /= primitiveCellVolume;


	return inverseMatrix;
}

inline ChemToolkit::Crystallography::UnitCell::NumericalMatrix ChemToolkit::Crystallography::UnitCell::getReciprocalVectors() const noexcept
{
	NumericalMatrix reciprocalVectors;
	{
		reciprocalVectors(0, 0) = (_basisVectors(1, 1) * _basisVectors(2, 2)) - (_basisVectors(2, 1) * _basisVectors(1, 2));
		reciprocalVectors(0, 1) = (_basisVectors(2, 1) * _basisVectors(0, 2)) - (_basisVectors(0, 1) * _basisVectors(2, 2));
		reciprocalVectors(0, 2) = (_basisVectors(0, 1) * _basisVectors(1, 2)) - (_basisVectors(1, 1) * _basisVectors(0, 2));

		reciprocalVectors(1, 0) = (_basisVectors(1, 2) * _basisVectors(2, 0)) - (_basisVectors(2, 2) * _basisVectors(1, 0));
		reciprocalVectors(1, 1) = (_basisVectors(2, 2) * _basisVectors(0, 0)) - (_basisVectors(0, 2) * _basisVectors(2, 0));
		reciprocalVectors(1, 2) = (_basisVectors(0, 2) * _basisVectors(1, 0)) - (_basisVectors(1, 2) * _basisVectors(0, 0));

		reciprocalVectors(2, 0) = (_basisVectors(1, 0) * _basisVectors(2, 1)) - (_basisVectors(2, 0) * _basisVectors(1, 1));
		reciprocalVectors(2, 1) = (_basisVectors(2, 0) * _basisVectors(0, 1)) - (_basisVectors(0, 0) * _basisVectors(2, 1));
		reciprocalVectors(2, 2) = (_basisVectors(0, 0) * _basisVectors(1, 1)) - (_basisVectors(1, 0) * _basisVectors(0, 1));
	}

	double primitiveCellVolume = 0.0;
	{
		primitiveCellVolume += _basisVectors(0, 0) * reciprocalVectors(0, 0);
		primitiveCellVolume += _basisVectors(1, 0) * reciprocalVectors(0, 1);
		primitiveCellVolume += _basisVectors(2, 0) * reciprocalVectors(0, 2);
	}

	reciprocalVectors *= (2.0 * MathToolkit::Generic::MathConstants::getPi());
	reciprocalVectors /= primitiveCellVolume;


	return reciprocalVectors;
}

inline bool ChemToolkit::Crystallography::UnitCell::hasPositiveVolume() const noexcept
{
	if (0.0 < getCellVolume())
		return true;
	else
		return false;
}

inline double ChemToolkit::Crystallography::UnitCell::getCellVolume() const noexcept
{
	double primitiveCellVolume{ 0.0 };
	{
		primitiveCellVolume += _basisVectors(0, 0) * ((_basisVectors(1, 1) * _basisVectors(2, 2)) - (_basisVectors(2, 1) * _basisVectors(1, 2)));
		primitiveCellVolume += _basisVectors(1, 0) * ((_basisVectors(2, 1) * _basisVectors(0, 2)) - (_basisVectors(0, 1) * _basisVectors(2, 2)));
		primitiveCellVolume += _basisVectors(2, 0) * ((_basisVectors(0, 1) * _basisVectors(1, 2)) - (_basisVectors(1, 1) * _basisVectors(0, 2)));
	}

	return primitiveCellVolume;
}

inline void ChemToolkit::Crystallography::UnitCell::clear() noexcept
{
	_basisVectors = 0.0;
	_basisVectors(0, 0) = 1.0;
	_basisVectors(1, 1) = 1.0;
	_basisVectors(2, 2) = 1.0;
}

// Methods
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Private methods

inline double ChemToolkit::Crystallography::UnitCell::getAngle(const NumericalVector& nva, const NumericalVector& nvb) const noexcept
{
	double angle = 0.0;
	{
		double cosine = MathToolkit::LinearAlgebra::getInnerProduct(nva, nvb);
		cosine /= std::sqrt(nva.normSquare() * nvb.normSquare());
		angle = std::acos(cosine);
	}

	return angle;
}

// Private methods
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************


#endif // !CHEMTOOLKIT_CRYSTALLOGRAPHY_UNITCELL_H
