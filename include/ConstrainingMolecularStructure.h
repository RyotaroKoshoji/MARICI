#ifndef MATHEMATICALCRYSTALCHEMISTRY_CRYSTALMODEL_COMPONENTS_CONSTRAININGMOLECULARSTRUCTURE_H
#define MATHEMATICALCRYSTALCHEMISTRY_CRYSTALMODEL_COMPONENTS_CONSTRAININGMOLECULARSTRUCTURE_H

#include <random>

#include "LinkedPolyhedraRetriever.h"


namespace MathematicalCrystalChemistry
{
	namespace CrystalModel
	{
		namespace Components
		{
			class ObjectiveMolecularStructure;
			class OptimalMolecularStructure;


			class ConstrainingMolecularStructure :public Internal::LinkedPolyhedraRetriever
			{
// **********************************************************************************************************************************************************************************************************************************************************************************************
			// Constructors, destructor, and operators

			public:
				ConstrainingMolecularStructure() noexcept;
				explicit ConstrainingMolecularStructure(const ObjectiveMolecularStructure&);

				virtual ~ConstrainingMolecularStructure() = default;

				ConstrainingMolecularStructure(const ConstrainingMolecularStructure&) = default;
				ConstrainingMolecularStructure(ConstrainingMolecularStructure&&) noexcept = default;
				ConstrainingMolecularStructure& operator=(const ConstrainingMolecularStructure&) = default;
				ConstrainingMolecularStructure& operator=(ConstrainingMolecularStructure&&) noexcept = default;

			// Constructors, destructor, and operators
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
			// Methods

				void initialize() noexcept override;
				void initialize(const std::vector<ConstrainingAtom>&) noexcept;
				void initialize(std::vector<ConstrainingAtom>&&) noexcept;

				void importStructure(const ObjectiveMolecularStructure&);
				void import(const ObjectiveMolecularStructure&);

				void distortStructure();
				void distortStructureLargely();


				void createInteratomicDistanceConstraints();
				void eraseInfeasibleIonicPolyhedraConnections();

				bool isFeasible() const;
				bool isFeasibleCoordinationComposition() const;

			// Methods
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
			// Private methods

			private:
				void createChemicalBonds();
				void optimizeCoordinationCompositions();

				void centerAtoms();
				double getAtomicSphereVolume() const;

			// Private methods
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
			// Private utility

				void makeClosestCoordinationComposition(const OriginalAtomIndex);

				bool willChooseOriginalAtomIndex(const ConstrainerIndices<TranslatedAtomIndex>&) const;

			// Private utility
// **********************************************************************************************************************************************************************************************************************************************************************************************

			private:
				mutable std::mt19937 m_randomEngine;
			};
		}
	}
}

// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Methods

inline void MathematicalCrystalChemistry::CrystalModel::Components::ConstrainingMolecularStructure::createInteratomicDistanceConstraints()
{
	clearCovalentBonds();
	clearIonicBonds();
	clearIonicRepulsions();

	CrystallineConstraintManager::updateConstrainingIndexPairs();
	createChemicalBonds();
	optimizeCoordinationCompositions();
}

inline bool MathematicalCrystalChemistry::CrystalModel::Components::ConstrainingMolecularStructure::isFeasibleCoordinationComposition() const
{
	for (size_type index = 0; index < atoms().size(); ++index)
	{
		if (!(hasFeasibleCoordinationComposition(index)))
			return false;
	}

	return true;
}

// Methods
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Private methods

inline void MathematicalCrystalChemistry::CrystalModel::Components::ConstrainingMolecularStructure::centerAtoms()
{
	NumericalMatrix inverseBasisVectors = unitCell().getInverseBasisVectors();
	NumericalVector averageFractionalCoordinate;
	{
		for (const auto& atom : atoms())
		{
			NumericalVector fractionalCoordinate = inverseBasisVectors * atom.cartesianCoordinate();
			averageFractionalCoordinate[0] += std::floor(fractionalCoordinate[0]);
			averageFractionalCoordinate[1] += std::floor(fractionalCoordinate[1]);
			averageFractionalCoordinate[2] += std::floor(fractionalCoordinate[2]);
		}

		averageFractionalCoordinate /= static_cast<double>(atoms().size());
	}


	for (auto& atom : atoms())
	{
		NumericalVector fractionalCoordinate = inverseBasisVectors * atom.cartesianCoordinate();
		{
			fractionalCoordinate -= averageFractionalCoordinate;
			fractionalCoordinate[0] += 0.5;
			fractionalCoordinate[1] += 0.5;
			fractionalCoordinate[2] += 0.5;
		}

		atom.cartesianCoordinate() = (unitCell().basisVectors() * fractionalCoordinate);
	}
}

inline double MathematicalCrystalChemistry::CrystalModel::Components::ConstrainingMolecularStructure::getAtomicSphereVolume() const
{
	double atomicVolume = 0.0;
	{
		for (const auto& atom : atoms())
		{
			if (atom.ionicAtomicNumber().formalCharge().isAnion() || atom.ionicAtomicNumber().formalCharge().isCation())
				atomicVolume += 1.33333333333333 * MathToolkit::Generic::MathConstants::getPi() * atom.ionicRadius().minimum() * atom.ionicRadius().minimum() * atom.ionicRadius().minimum();
			else
				atomicVolume += 1.33333333333333 * MathToolkit::Generic::MathConstants::getPi() * atom.covalentRadius().minimum() * atom.covalentRadius().minimum() * atom.covalentRadius().minimum();
		}
	}

	return atomicVolume;
}

// Private methods
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Private utility

inline bool MathematicalCrystalChemistry::CrystalModel::Components::ConstrainingMolecularStructure::willChooseOriginalAtomIndex(const ConstrainerIndices<TranslatedAtomIndex>& constrainerIndices) const
{
	std::uniform_int_distribution<int> selector{ 0,1 };

	if (selector(m_randomEngine) == 0)
		return true;
	else
		return false;
}

// Private utility
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************


#endif // !MATHEMATICALCRYSTALCHEMISTRY_CRYSTALMODEL_COMPONENTS_CONSTRAININGMOLECULARSTRUCTURE_H
