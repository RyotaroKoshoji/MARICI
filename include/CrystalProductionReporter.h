#ifndef MATHEMATICALCRYSTALCHEMISTRY_DESIGN_DIAGNOSTICS_CRYSTALPRODUCTIONREPORTER_H
#define MATHEMATICALCRYSTALCHEMISTRY_DESIGN_DIAGNOSTICS_CRYSTALPRODUCTIONREPORTER_H

#include <filesystem>
#include <mutex>
#include <utility>

#include "CrystalDesignRecorder.h"
#include "CrystalProductionReportParameters.h"

#include "ChemicalComposition.h"

#include "OptimalCrystalStructure.h"


namespace MathematicalCrystalChemistry
{
	namespace Design
	{
		namespace Diagnostics
		{
			class CrystalProductionReporter
			{
				using size_type = std::size_t;

				using AtomicNumber = ChemToolkit::Generic::AtomicNumber;
				using SpaceGroupNumber = ChemToolkit::Crystallography::Symmetry::SpaceGroupNumber;
				using ChemicalComposition = ChemToolkit::Generic::ChemicalComposition<AtomicNumber>;

				using OptimalCrystalStructure = MathematicalCrystalChemistry::CrystalModel::Components::OptimalCrystalStructure;

// **********************************************************************************************************************************************************************************************************************************************************************************************
			// Constructors, destructor, and operators

			public:
				CrystalProductionReporter() noexcept;
				explicit CrystalProductionReporter(const CrystalProductionReportParameters&);

				virtual ~CrystalProductionReporter() = default;

				CrystalProductionReporter(const CrystalProductionReporter&) = default;
				CrystalProductionReporter(CrystalProductionReporter&&) noexcept = default;
				CrystalProductionReporter& operator=(const CrystalProductionReporter&) = default;
				CrystalProductionReporter& operator=(CrystalProductionReporter&&) noexcept = default;

			// Constructors, destructor, and operators
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
			// Property

				const std::filesystem::path& designedCrystalsDirectoryPath() const noexcept;

				const CrystalDesignRecorder& crystalDesignRecorder() const noexcept;
				CrystalDesignRecorder& crystalDesignRecorder() noexcept;

				void setCrystalProductionReportParameters(const CrystalProductionReportParameters&);

			// Property
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
			// Methods

				void outputFeasibleCrystalStructure(const OptimalCrystalStructure&) const;
				void outputFeasibleCrystalStructure(const OptimalCrystalStructure&, const std::filesystem::path& producedDirectoryPath) const;

				void outputInfeasibleCrystalStructure(const OptimalCrystalStructure&, const std::string& productionName) const;
				void outputInfeasibleCrystalStructure(const OptimalCrystalStructure&, const std::filesystem::path& producedDirectoryPath) const;

				void outputExceptionalCrystalStructure(const OptimalCrystalStructure&, const ChemicalComposition&, const std::string& productionName) const;
				void outputExceptionalCrystalStructure(const OptimalCrystalStructure&, const ChemicalComposition&, const std::filesystem::path& producedDirectoryPath) const;

			// Methods
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
			// Private methods

			private:
				std::filesystem::path getSpaceGroupDirectoryPath(const SpaceGroupNumber, const ChemicalComposition&) const;

				std::pair<bool, std::filesystem::path> getOutputDirectoryPath(const std::string& outputFingerprint, const std::filesystem::path& spaceGroupPath) const;
				std::string getDirectoryName(const std::filesystem::path& directoryPath) const;

				void outputFeasibleCrystallographicData(const OptimalCrystalStructure& conventionalCrystalStructure, const OptimalCrystalStructure& optimalCrystalStructure, const std::filesystem::path& outputDirectoryPath) const;
				void outputInfeasibleCrystallographicData(const OptimalCrystalStructure& optimalCrystalStructure, const std::filesystem::path& outputDirectoryPath) const;

			// Private methods
// **********************************************************************************************************************************************************************************************************************************************************************************************

			private:
				CrystalDesignRecorder _crystalDesignRecorder;
				CrystalProductionReportParameters _crystalProductionReportParameters;

				static std::mutex s_reportMutex;
				static std::string s_fingerprintFilename;
			};
		}
	}
}

// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Property

inline const std::filesystem::path& MathematicalCrystalChemistry::Design::Diagnostics::CrystalProductionReporter::designedCrystalsDirectoryPath() const noexcept
{
	return _crystalProductionReportParameters.designedCrystalsDirectoryPath();
}

inline const MathematicalCrystalChemistry::Design::Diagnostics::CrystalDesignRecorder& MathematicalCrystalChemistry::Design::Diagnostics::CrystalProductionReporter::crystalDesignRecorder() const noexcept
{
	return _crystalDesignRecorder;
}

inline MathematicalCrystalChemistry::Design::Diagnostics::CrystalDesignRecorder& MathematicalCrystalChemistry::Design::Diagnostics::CrystalProductionReporter::crystalDesignRecorder() noexcept
{
	return _crystalDesignRecorder;
}

// Property
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// Private methods

inline std::string MathematicalCrystalChemistry::Design::Diagnostics::CrystalProductionReporter::getDirectoryName(const std::filesystem::path& directoryPath) const
{
	std::string directoryPathTexts = directoryPath.generic_string();
	{
		if (directoryPathTexts.back() == '/' || directoryPathTexts.back() == '\\')
			directoryPathTexts.pop_back();
	}

	return std::filesystem::path{ directoryPathTexts }.filename().string();
}

// Private methods
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************
// **********************************************************************************************************************************************************************************************************************************************************************************************


#endif // !MATHEMATICALCRYSTALCHEMISTRY_DESIGN_DIAGNOSTICS_CRYSTALPRODUCTIONREPORTER_H
